<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Wizard RP — PDA Policial (En línea)</title>
<link rel="icon" href="https://cdn.discordapp.com/attachments/1421898595271180360/1422217488145453219/LOGO_WIZARD_FONDO.png.png">
<style>
  :root{
    --bg:#071018; --muted:#98a8b0; --accent:#844ffc; --accent-2:#6ee7b7;
    --card:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    --glass: rgba(255,255,255,0.03);
    --radius:14px;
    --danger:#ff6b6b;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:
    radial-gradient(900px 350px at 10% 10%, rgba(132,79,252,0.06), transparent),
    linear-gradient(180deg,#03121a 0%,var(--bg) 60%);
    color:#e7eef6; -webkit-font-smoothing:antialiased;}
  .wrap{max-width:1180px;margin:18px auto;padding:18px;display:grid;grid-template-rows:auto 1fr;gap:14px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:56px;height:56px;border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent-2),var(--accent))}
  .logo img{width:100%;height:100%;object-fit:cover}
  h1{margin:0;font-size:18px}
  .subtitle{color:var(--muted);font-size:13px}
  .top-right{display:flex;gap:8px;align-items:center}
  .pill{background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:999px;font-weight:700}
  .small{font-size:12px;color:var(--muted)}
  .btn{background:var(--accent);color:#fff;padding:8px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:800;box-shadow:0 6px 18px rgba(132,79,252,0.12);transition:transform .12s,opacity .12s}
  .btn:active{transform:translateY(1px)}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:7px 10px;border-radius:10px;cursor:pointer}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;padding:6px}
  .card{
    background:var(--card);border-radius:var(--radius);padding:18px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(2,6,10,0.6);
    cursor:pointer;overflow:hidden;position:relative;transition:transform .28s, box-shadow .28s, border-color .18s;
    display:flex;flex-direction:column;gap:12px;min-height:120px;
  }
  .card:hover{transform:translateY(-8px);box-shadow:0 18px 40px rgba(2,6,10,0.75);border-color:rgba(132,79,252,0.12)}
  .card .title{font-weight:900;font-size:16px}
  .card .desc{color:var(--muted);font-size:13px}
  .card .cta{margin-top:auto;display:flex;justify-content:space-between;align-items:center}
  .icon {width:56px;height:56px;border-radius:10px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:20px;transition:transform .35s}
  .card:hover .icon{transform:rotate(8deg) scale(1.06)}
  .expanded{margin-top:14px;border-radius:var(--radius);padding:18px;background:var(--card);border:1px solid rgba(255,255,255,0.03)}
  .form-row{display:flex;gap:8px}
  input, textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  textarea{min-height:120px;resize:vertical}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{padding:10px;border-radius:10px;background:var(--glass);display:flex;justify-content:space-between;align-items:center}
  .muted{color:var(--muted)}
  .danger{background:linear-gradient(90deg,#ff8a80,#ff5252);color:#041018;padding:6px 8px;border-radius:8px}
  .ok{background:linear-gradient(90deg,#48c774,#34d399);color:#041018;padding:6px 8px;border-radius:8px}
  .tiny{font-size:12px}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  .overlay{position:fixed;inset:0;background:linear-gradient(rgba(2,6,10,0.6),rgba(2,6,10,0.8));display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{width:720px;max-width:94%;background:linear-gradient(180deg,#071729,#061421);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .link-like{color:var(--accent);cursor:pointer;text-decoration:underline}
  .role-chip{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);margin-right:6px;margin-bottom:6px}
  .btn-small{padding:6px 8px;font-size:13px;border-radius:8px}
  @media (max-width:980px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} .form-row{flex-direction:column} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"><img id="logoImg" src="https://cdn.discordapp.com/attachments/1421898595271180360/1422217488145453219/LOGO_WIZARD_FONDO.png.png" alt="logo"></div>
        <div>
          <h1>Wizard RP — PDA / CAD</h1>
          <div class="subtitle">Simulador en línea — comparte la URL</div>
        </div>
      </div>

      <div class="top-right">
        <div class="pill small" id="userDisplay">No conectado</div>
        <div class="pill small" id="dutyStatus">En servicio: 0</div>
        <button id="btnExport" class="btn">Exportar</button>
        <button id="btnLogin" class="btn-ghost">Iniciar sesión</button>
      </div>
    </header>

    <section class="grid" id="cardsRoot">
      <!-- cards inyectadas por JS -->
    </section>

    <div id="expandedRoot"></div>

    <footer>Hecho para Wizard RP • Datos en Firestore • UI lista para usar</footer>
  </div>

  <!-- LOGIN / REGISTER modal (mantengo tu sistema original) -->
  <div id="loginModal" class="overlay" style="display:none">
    <div class="modal">
      <h3>Entrar / Registrarse</h3>
      <div class="muted small">Usa tu cuenta o crea una. Los datos se guardan en Firestore (proyecto: wizard-rp).</div>

      <div style="margin-top:12px">
        <label class="muted small">Usuario</label>
        <input id="loginUser" placeholder="usuario (ej: perety04)"/>
        <label class="muted small" style="margin-top:8px">Contraseña</label>
        <input id="loginPass" type="password" placeholder="contraseña"/>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="loginBtnModal" class="btn">Entrar</button>
          <button id="guestBtn" class="btn-ghost">Invitado</button>
          <div style="margin-left:auto" class="small muted">¿Sin cuenta? <span id="showReg" class="link-like">Crear</span></div>
        </div>
        <div id="loginError" class="muted small" style="margin-top:8px;color:#ff9b9b;display:none"></div>
      </div>

      <div id="registerBlock" style="display:none;margin-top:12px;border-top:1px dashed rgba(255,255,255,0.03);padding-top:12px">
        <h4 style="margin:0 0 8px 0">Crear cuenta</h4>
        <label class="muted small">Nombre visible</label>
        <input id="regName" placeholder="Ej: Ofc. Pérez"/>
        <label class="muted small">Usuario</label>
        <input id="regUser" placeholder="usuario (ej: perety04)"/>
        <label class="muted small">Contraseña</label>
        <input id="regPass" type="password" placeholder="contraseña"/>
        <div style="display:flex;gap:8px;margin-top:8px">
          <select id="regRole">
            <option value="officer">Officer</option>
            <option value="sergeant">Sergeant</option>
            <option value="dispatcher">Dispatcher</option>
            <option value="admin">Admin</option>
          </select>
          <button id="regCreate" class="btn">Crear</button>
          <button id="regCancel" class="btn-ghost">Cancelar</button>
        </div>
        <div id="regMsg" class="muted small" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

<script type="module">
/* ===========================================================
   Wizard RP — Single-file index.html (full)
   Firestore real-time sync for multi-user (online) usage
   - Collections used: users, roles, pda, reports, calls, fines, wanted, logs, onDuty
   - Login/Register modal preserved (your original flow)
   - Admin panel visible only to role === 'admin'
   NOTE: This file expects Firestore enabled in the project 'wizard-rp'
   =========================================================== */

/* ---------------- Firebase SDK (Firestore) ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getFirestore, collection, addDoc, doc, setDoc, getDoc, getDocs, onSnapshot, query, where, orderBy, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/* ---------- Replace with your firebaseConfig (you already gave it) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyCskczYgGtlPPBEIZiE5PuY7s_cfE_3Chg",
  authDomain: "wizard-rp.firebaseapp.com",
  projectId: "wizard-rp",
  storageBucket: "wizard-rp.firebasestorage.app",
  messagingSenderId: "479456044047",
  appId: "1:479456044047:web:65c52e2430bcb6ca586f7a",
  measurementId: "G-KX5Y56CG0R"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------------- Helpers & state ---------------- */
const PREFIX = 'pda_v_final_';
function uid(pref='id'){ return pref+'_'+Math.random().toString(36).slice(2,9); }
function now(){ return Date.now(); }
function el(id){ return document.getElementById(id); }
function show(elm){ elm.style.display = ''; }
function hide(elm){ elm.style.display = 'none'; }

let STATE = {
  currentUser: null
};

/* ---------------- DOM refs ---------------- */
const cardsRoot = el('cardsRoot');
const expandedRoot = el('expandedRoot');
const userDisplay = el('userDisplay');
const dutyStatus = el('dutyStatus');
const loginModal = el('loginModal');
const btnLogin = el('btnLogin');
const btnExport = el('btnExport');

/* ---------------- Permission util (based on role document) ---------------- */
async function hasPerm(roleKey, perm){
  if(!roleKey) return perm === 'create_call' ? true : false;
  const rolesSnap = await getDocs(collection(db,'roles'));
  const roles = {};
  rolesSnap.forEach(r => roles[r.id] = r.data());
  const role = roles[roleKey];
  if(!role) return false;
  if(Array.isArray(role.permissions) && role.permissions.includes('all')) return true;
  return Array.isArray(role.permissions) && role.permissions.includes(perm);
}

/* ---------------- UI: Cards ---------------- */
const CARDS = [
  {id:'pda', title:'PDA', desc:'Buscar / Crear fichas', icon:'🔍'},
  {id:'calls', title:'Dispatch', desc:'Crear y asignar llamadas', icon:'📞'},
  {id:'reports', title:'Informes', desc:'Crear y consultar informes', icon:'📑'},
  {id:'wanted', title:'BOLO', desc:'Fichas buscados', icon:'🚨'},
  {id:'fines', title:'Multas', desc:'Generar sanciones', icon:'💸'},
  {id:'service', title:'Servicio', desc:'Entrar / Salir de servicio', icon:'🟢'},
  {id:'admin', title:'Administración', desc:'Gestionar roles y usuarios', icon:'⚙️'},
  {id:'audit', title:'Auditoría', desc:'Historial de acciones', icon:'📜'},
  {id:'tools', title:'Herramientas', desc:'Exportar / Importar', icon:'🧰'}
];

function renderCards(){
  cardsRoot.innerHTML = '';
  CARDS.forEach(c=>{
    const card = document.createElement('div'); card.className = 'card'; card.dataset.id = c.id;
    card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><div class="title">${c.title}</div><div class="desc">${c.desc}</div></div>
      <div class="icon">${c.icon}</div>
    </div>
    <div class="cta"><div class="muted tiny">Acción</div><button class="btn-small btn" data-open="${c.id}" style="background:var(--accent);border-radius:8px;padding:6px 8px">Abrir</button></div>`;
    card.onclick = ()=> openCard(c.id);
    card.querySelector('button[data-open]').onclick = (e)=>{ e.stopPropagation(); openCard(c.id); };
    cardsRoot.appendChild(card);
  });
}

/* ---------------- Open card ---------------- */
function openCard(id){
  expandedRoot.innerHTML = '';
  const panel = document.createElement('div'); panel.className='expanded';
  if(id==='pda') renderPDA(panel);
  else if(id==='calls') renderCalls(panel);
  else if(id==='reports') renderReports(panel);
  else if(id==='wanted') renderWanted(panel);
  else if(id==='fines') renderFines(panel);
  else if(id==='service') renderService(panel);
  else if(id==='admin') renderAdmin(panel);
  else if(id==='audit') renderAudit(panel);
  else if(id==='tools') renderTools(panel);
  expandedRoot.appendChild(panel);
  panel.scrollIntoView({behavior:'smooth',block:'start'});
}

/* ================= PDA ================= */
function renderPDA(container){
  container.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>PDA / Fichas</strong><div class="muted small">Buscar y crear fichas (plantilla editable)</div></div>
      <div><button class="btn btn-small" id="closeP">Cerrar</button></div>
    </div>
    <div style="margin-top:12px;display:grid;grid-template-columns:1fr 320px;gap:12px">
      <div>
        <input id="pdaQ" placeholder="Buscar por nombre, alias o texto..." />
        <div id="pdaResults" style="margin-top:10px" class="list"></div>
      </div>
      <div>
        <div class="muted small">Plantilla</div>
        <textarea id="pdaTpl" style="min-height:160px">Nombre: {{name}}
Alias: {{alias}}
Notas: {{notes}}</textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="createPDA" class="btn">Crear ficha</button>
          <button id="clearPDA" class="btn-ghost">Limpiar</button>
        </div>
      </div>
    </div>`;
  container.querySelector('#closeP').onclick = ()=> closeExpanded();
  el('pdaQ').oninput = ()=> searchPDA(el('pdaQ').value);
  el('createPDA').onclick = createPDA;
  el('clearPDA').onclick = ()=> el('pdaTpl').value = '';
  // live list
  const q = query(collection(db,'pda'), orderBy('created','desc'));
  onSnapshot(q, snap => {
    const out = [];
    snap.forEach(d => out.push({id:d.id, ...d.data()}));
    renderPDAResults(out);
  });
}
function renderPDAResults(items){
  const root = el('pdaResults');
  if(!root) return;
  if(!items.length) { root.innerHTML = '<div class="muted small">Sin fichas</div>'; return; }
  root.innerHTML = '';
  items.forEach(p=>{
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${(p.title||p.text||'Ficha')}</div><div class="muted small">${(p.text||'').slice(0,140)}</div></div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end"><div class="muted tiny">${new Date(p.created).toLocaleString()}</div>
      <div><button class="btn-ghost btn-small" data-id="${p.id}" data-act="view">Ver</button> <button class="btn-ghost btn-small" data-id="${p.id}" data-act="del">Borrar</button></div></div>`;
    it.querySelector('button[data-act="view"]').onclick = ()=> viewPDA(p);
    it.querySelector('button[data-act="del"]').onclick = async ()=> { if(!confirm('Borrar ficha?')) return; await deleteDoc(doc(db,'pda',p.id)); await logIfPrivileged(`PDA borrada: ${p.id}`); };
    root.appendChild(it);
  });
}
async function createPDA(){
  if(!STATE.currentUser) return alert('Debes iniciar sesión');
  // check role permission quickly (roles stored in collection 'roles')
  const roleKey = STATE.currentUser.role;
  const ok = await hasPerm(roleKey,'create_pda');
  if(!ok){ alert('No tienes permiso para crear PDA'); return; }
  const text = el('pdaTpl').value.trim();
  if(!text){ alert('Rellena la plantilla'); return; }
  const title = (text.split('\n')[0]||'Ficha').replace('Nombre:','').trim();
  await addDoc(collection(db,'pda'), { text, title, author: STATE.currentUser.display, created: now(), authorId: STATE.currentUser._id || STATE.currentUser.uid });
  el('pdaTpl').value = '';
  await logIfPrivileged(`PDA creada por ${STATE.currentUser.username}`);
}
function viewPDA(p){ alert(`Ficha: ${p.title || 'Ficha'}\n\n${p.text}\n\nAutor: ${p.author || '—'}\nFecha: ${new Date(p.created).toLocaleString()}`); }

/* ================= Calls / Dispatch ================= */
function renderCalls(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Dispatch / Llamadas</strong><div class="muted small">Crear llamadas y asignar unidades</div></div>
    <div><button class="btn btn-small" id="closeC">Cerrar</button></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:8px">
    <input id="callFrom" placeholder="Remitente (opcional)"/>
    <input id="callMsg" placeholder="Mensaje"/>
    <button id="callCreate" class="btn">Crear llamada</button>
  </div>
  <div style="margin-top:12px"><strong>Llamadas</strong><div id="callsList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeC').onclick = ()=> closeExpanded();
  container.querySelector('#callCreate').onclick = createCall;
  const q = query(collection(db,'calls'), orderBy('created','desc'));
  onSnapshot(q, snap => {
    const arr = []; snap.forEach(d => arr.push({id:d.id, ...d.data()})); renderCallsList(arr);
  });
}
async function createCall(){
  const caller = el('callFrom').value.trim() || 'Anonimo';
  const message = el('callMsg').value.trim();
  if(!message) return alert('Introduce un mensaje');
  await addDoc(collection(db,'calls'), { caller, message, status:'pending', assigned_to:null, created: now(), author: STATE.currentUser ? STATE.currentUser.display : 'Invitado', authorId: STATE.currentUser ? (STATE.currentUser.uid||STATE.currentUser._id) : null });
  el('callMsg').value=''; el('callFrom').value='';
  await logIfPrivileged(`Llamada creada: ${caller}`);
}
function renderCallsList(calls){
  const root = el('callsList'); root.innerHTML='';
  if(!calls.length){ root.innerHTML='<div class="muted small">No hay llamadas</div>'; return; }
  calls.forEach(c =>{
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${c.caller}</div><div class="muted small">${c.message}</div></div>
      <div style="text-align:right"><div class="muted tiny">${new Date(c.created).toLocaleString()}</div><div style="margin-top:8px" class="muted tiny">Asig: ${c.assigned_to_name || '—'}</div>
      <div style="margin-top:8px"></div></div>`;
    const btns = document.createElement('div'); btns.style.marginLeft='12px';
    // Assign to self (if permitted)
    const assignBtn = document.createElement('button'); assignBtn.className='btn-ghost btn-small'; assignBtn.textContent='Asignar a mí';
    assignBtn.onclick = async ()=>{
      if(!STATE.currentUser) return alert('Inicia sesión');
      const ok = await hasPerm(STATE.currentUser.role,'assign_call');
      if(!ok) return alert('No autorizado para asignar llamadas');
      await updateDoc(doc(db,'calls',c.id), { status:'assigned', assigned_to: STATE.currentUser._id || STATE.currentUser.uid || STATE.currentUser.username });
      await logIfPrivileged(`Llamada ${c.id} asignada a ${STATE.currentUser.username}`);
    };
    btns.appendChild(assignBtn);
    // delete if admin or assigned
    const delBtn = document.createElement('button'); delBtn.className='btn btn-small'; delBtn.style.marginLeft='6px'; delBtn.textContent='Borrar';
    delBtn.onclick = async ()=>{
      if(!STATE.currentUser) return alert('Inicia sesión');
      if(STATE.currentUser.role!=='admin' && (c.assigned_to !== (STATE.currentUser._id || STATE.currentUser.uid || STATE.currentUser.username))) return alert('No autorizado');
      if(!confirm('Borrar llamada?')) return;
      await deleteDoc(doc(db,'calls',c.id));
      await logIfPrivileged(`Llamada ${c.id} borrada`);
    };
    btns.appendChild(delBtn);
    it.appendChild(btns);
    root.appendChild(it);
  });
}

/* ================= Reports ================= */
function renderReports(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Informes</strong><div class="muted small">Crear y consultar informes</div></div>
    <div><button class="btn btn-small" id="closeR">Cerrar</button></div>
  </div>
  <div style="margin-top:12px">
    <div class="muted small">Plantilla (editable)</div>
    <textarea id="tplReport" style="min-height:80px">Título: {{title}}\nHechos: {{facts}}\nAcciones: {{actions}}\nOficial: {{author}}</textarea>
  </div>
  <div style="margin-top:8px" class="form-row">
    <input id="repTitle" placeholder="Título" />
    <input id="repAuthor" placeholder="Autor (auto)" />
  </div>
  <div style="margin-top:8px"><textarea id="repDesc" placeholder="Descripción..."></textarea></div>
  <div style="margin-top:8px;display:flex;gap:8px"><button id="saveRep" class="btn">Guardar informe</button><button id="clearRep" class="btn-ghost">Limpiar</button></div>
  <div style="margin-top:12px"><strong>Últimos informes</strong><div id="reportsList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeR').onclick = ()=> closeExpanded();
  el('repAuthor').value = STATE.currentUser ? STATE.currentUser.display : 'Invitado';
  el('saveRep').onclick = saveReport; el('clearRep').onclick = ()=>{ el('repTitle').value=''; el('repDesc').value=''; };
  onSnapshot(query(collection(db,'reports'), orderBy('created','desc')), snap => {
    const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
    renderReportsList(arr);
  });
}
async function saveReport(){
  if(!STATE.currentUser) return alert('Debes iniciar sesión');
  const ok = await hasPerm(STATE.currentUser.role,'create_reports');
  if(!ok) return alert('No tienes permiso para crear informes');
  const title = el('repTitle').value.trim(); const desc = el('repDesc').value.trim();
  if(!title || !desc) return alert('Título y descripción obligatorios');
  await addDoc(collection(db,'reports'), { title, description:desc, author:STATE.currentUser.display, authorId:STATE.currentUser._id||STATE.currentUser.uid, created: now() });
  await logIfPrivileged(`Informe creado: ${title}`);
  el('repTitle').value=''; el('repDesc').value='';
}
function renderReportsList(list){
  const root = el('reportsList'); root.innerHTML='';
  if(!list.length){ root.innerHTML = '<div class="muted small">No hay informes</div>'; return; }
  list.forEach(r=>{
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${r.title}</div><div class="muted small">${(r.description||'').slice(0,160)}</div></div>
      <div style="text-align:right"><div class="muted tiny">${new Date(r.created).toLocaleString()}</div><div style="margin-top:6px" class="muted tiny">${r.author||''}</div></div>`;
    const btns = document.createElement('div'); btns.style.marginLeft='12px';
    const view = document.createElement('button'); view.className='btn-ghost btn-small'; view.textContent='Ver';
    view.onclick = ()=> alert(`Informe — ${r.title}\n\n${r.description}\n\nAutor: ${r.author}\nFecha: ${new Date(r.created).toLocaleString()}`);
    btns.appendChild(view);
    if(STATE.currentUser && (STATE.currentUser.role==='admin' || STATE.currentUser.role==='sergeant')){
      const del = document.createElement('button'); del.className='btn btn-small'; del.style.marginLeft='6px'; del.textContent='Borrar';
      del.onclick = async ()=>{ if(confirm('Borrar informe?')){ await deleteDoc(doc(db,'reports',r.id)); await logIfPrivileged(`Informe ${r.id} borrado`);} };
      btns.appendChild(del);
    }
    it.appendChild(btns);
    root.appendChild(it);
  });
}

/* ================= Wanted (BOLO) ================= */
function renderWanted(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>BOLO / Wanted</strong><div class="muted small">Crear y gestionar fichas buscadas</div></div>
    <div><button class="btn btn-small" id="closeW">Cerrar</button></div>
  </div>
  <div style="margin-top:12px" class="form-row">
    <input id="wName" placeholder="Nombre / Alias" />
    <input id="wBounty" placeholder="Recompensa" />
  </div>
  <div style="margin-top:8px"><textarea id="wDesc" placeholder="Descripción"></textarea></div>
  <div style="margin-top:8px;display:flex;gap:8px"><button id="saveW" class="btn">Crear ficha</button></div>
  <div style="margin-top:12px"><strong>Fichas</strong><div id="wantedList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeW').onclick = ()=> closeExpanded();
  el('saveW').onclick = async ()=>{
    if(!STATE.currentUser) return alert('Inicia sesión');
    const ok = await hasPerm(STATE.currentUser.role,'create_bolo');
    if(!ok) return alert('No tienes permiso');
    const name = el('wName').value.trim(), desc = el('wDesc').value.trim(), bounty = parseInt(el('wBounty').value||'0',10);
    if(!name) return alert('Nombre requerido');
    await addDoc(collection(db,'wanted'), { name, description:desc, bounty, created: now(), author:STATE.currentUser.display });
    el('wName').value=''; el('wDesc').value=''; el('wBounty').value='';
    await logIfPrivileged(`Wanted creado: ${name}`);
  };
  onSnapshot(query(collection(db,'wanted'), orderBy('created','desc')), snap => {
    const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()})); renderWantedList(arr);
  });
}
function renderWantedList(arr){
  const root = el('wantedList'); root.innerHTML='';
  if(!arr.length){ root.innerHTML = '<div class="muted small">No hay fichas</div>'; return; }
  arr.forEach(w=>{
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${w.name}</div><div class="muted small">${w.description}</div></div><div class="pill">${w.bounty||0}€</div>`;
    const btns = document.createElement('div'); btns.style.marginLeft='12px';
    const view = document.createElement('button'); view.className='btn-ghost btn-small'; view.textContent='Ver';
    view.onclick = ()=> alert(`Wanted — ${w.name}\n\n${w.description}\nRecompensa: ${w.bounty}€`);
    btns.appendChild(view);
    if(STATE.currentUser && (STATE.currentUser.role==='admin' || STATE.currentUser.role==='sergeant')){
      const del = document.createElement('button'); del.className='btn btn-small'; del.style.marginLeft='6px'; del.textContent='Borrar';
      del.onclick = async ()=>{ if(confirm('Borrar ficha?')){ await deleteDoc(doc(db,'wanted',w.id)); await logIfPrivileged(`Wanted ${w.id} borrado`); } };
      btns.appendChild(del);
    }
    it.appendChild(btns);
    root.appendChild(it);
  });
}

/* ================= Fines ================= */
function renderFines(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Multas</strong><div class="muted small">Genera sanciones y multas</div></div>
    <div><button class="btn btn-small" id="closeF">Cerrar</button></div>
  </div>
  <div style="margin-top:12px" class="form-row"><input id="fineOff" placeholder="Infractor (nombre/vehículo)"/><input id="fineAmt" placeholder="Importe"/></div>
  <div style="margin-top:8px"><textarea id="fineReason" placeholder="Motivo..."></textarea></div>
  <div style="margin-top:8px;display:flex;gap:8px"><button id="saveFine" class="btn">Emitir multa</button></div>
  <div style="margin-top:12px"><strong>Multas</strong><div id="finesList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeF').onclick = ()=> closeExpanded();
  el('saveFine').onclick = async ()=>{
    if(!STATE.currentUser) return alert('Inicia sesión');
    const ok = await hasPerm(STATE.currentUser.role,'create_fine');
    if(!ok) return alert('No tienes permiso');
    const off = el('fineOff').value.trim(); const amt = parseInt(el('fineAmt').value||'0',10); const reason = el('fineReason').value.trim();
    if(!off || !amt) return alert('Infractor e importe requeridos');
    await addDoc(collection(db,'fines'), { offender:off, amount:amt, reason, author:STATE.currentUser.display, created: now() });
    el('fineOff').value=''; el('fineAmt').value=''; el('fineReason').value='';
    await logIfPrivileged(`Multa creada: ${off} ${amt}€`);
  };
  onSnapshot(query(collection(db,'fines'), orderBy('created','desc')), snap => {
    const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()})); renderFinesList(arr);
  });
}
function renderFinesList(arr){
  const root = el('finesList'); root.innerHTML='';
  if(!arr.length){ root.innerHTML = '<div class="muted small">No hay multas</div>'; return; }
  arr.forEach(f=>{
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${f.offender} • ${f.amount}€</div><div class="muted small">${f.reason}</div></div><div class="muted tiny">${new Date(f.created).toLocaleString()}</div>`;
    const btns = document.createElement('div'); btns.style.marginLeft='12px';
    if(STATE.currentUser && (STATE.currentUser.role==='admin' || STATE.currentUser.display===f.author)){
      const del = document.createElement('button'); del.className='btn btn-small'; del.textContent='Borrar';
      del.onclick = async ()=>{ if(confirm('Borrar multa?')){ await deleteDoc(doc(db,'fines',f.id)); await logIfPrivileged(`Multa ${f.id} borrada`);} };
      btns.appendChild(del);
    }
    it.appendChild(btns);
    root.appendChild(it);
  });
}

/* ================= Service (on-duty) ================= */
function renderService(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Servicio</strong><div class="muted small">Ponte en servicio o sal</div></div>
    <div><button class="btn btn-small" id="closeS">Cerrar</button></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
    <div class="muted small">Tu estado:</div><div id="serviceBox" class="pill">Desconocido</div>
    <div style="margin-left:auto"><button id="toggleDuty" class="btn">Cambiar estado</button></div>
  </div>
  <div style="margin-top:12px"><strong>Policías en servicio</strong><div id="dutyList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeS').onclick = ()=> closeExpanded();
  const box = el('serviceBox');
  const on = async ()=> {
    const sdoc = await getDocs(collection(db,'onDuty'));
    const active = []; sdoc.forEach(d=>{ if(d.data().on) active.push(d.data()); });
    return active;
  };
  // toggle
  el('toggleDuty').onclick = async ()=>{
    if(!STATE.currentUser) return alert('Inicia sesión');
    const uid = STATE.currentUser._id||STATE.currentUser.uid||STATE.currentUser.username;
    const ref = doc(db,'onDuty', uid);
    const current = await getDoc(ref);
    const newState = !(current.exists() && current.data().on);
    await setDoc(ref, { on: newState, userId: uid, display: STATE.currentUser.display, role: STATE.currentUser.role, updated: now() });
    await logIfPrivileged(`${STATE.currentUser.display} ${newState ? 'entró' : 'salió'} de servicio`);
  };
  // live duty list
  onSnapshot(collection(db,'onDuty'), snap=>{
    const active = [];
    snap.forEach(d=>{
      const jd = d.data();
      if(jd.on) active.push(jd);
    });
    el('dutyList').innerHTML = active.length ? active.map(a=>`<div class="item">${a.display} • ${a.role}</div>`).join('') : '<div class="muted small">Nadie en servicio</div>';
    dutyStatus.textContent = `En servicio: ${active.length}`;
  });
}

/* ================= Admin (roles & users) ================= */
async function renderAdmin(container){
  if(!STATE.currentUser || STATE.currentUser.role!=='admin'){
    container.innerHTML = `<div><strong>Administración</strong><div class="muted small">Solo accesible para admins</div></div>`;
    return;
  }
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Administración</strong><div class="muted small">Gestiona roles, permisos y usuarios</div></div>
    <div><button class="btn btn-small" id="closeA">Cerrar</button></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:12px">
    <div style="flex:1">
      <h4>Usuarios</h4>
      <div style="display:flex;gap:8px"><input id="adm_newUser" placeholder="username"/><input id="adm_newDisplay" placeholder="display"/></div>
      <div style="display:flex;gap:8px;margin-top:8px"><input id="adm_newPass" placeholder="password"/><select id="adm_newRole"></select></div>
      <div style="display:flex;gap:8px;margin-top:8px"><button id="adm_createUser" class="btn">Crear</button><button id="adm_refresh" class="btn-ghost">Refrescar</button></div>
      <div style="margin-top:12px"><strong>Lista de usuarios</strong><div id="usersAdminList" class="list" style="margin-top:8px"></div></div>
    </div>
    <div style="width:360px">
      <h4>Roles</h4>
      <div style="display:flex;gap:8px"><input id="adm_newRoleName" placeholder="nuevo rol"><button id="adm_createRole" class="btn">Crear rol</button></div>
      <div id="rolesAdminList" style="margin-top:12px"></div>
    </div>
  </div>`;
  el('closeA').onclick = ()=> closeExpanded();
  el('adm_createUser').onclick = adminCreateUser;
  el('adm_refresh').onclick = ()=> renderAdmin(container);
  el('adm_createRole').onclick = adminCreateRole;
  // load roles & users
  loadRolesAdmin();
  onSnapshot(collection(db,'users'), snap => {
    const users=[]; snap.forEach(d=>users.push({id:d.id, ...d.data()})); renderUsersAdmin(users);
  });
}

async function renderUsersAdmin(users){
  const ul = el('usersAdminList'); ul.innerHTML = '';
  if(!users.length){ ul.innerHTML = '<div class="muted small">No hay usuarios</div>'; return; }
  // ensure role select options are loaded
  const rolesSnap = await getDocs(collection(db,'roles'));
  const roles = []; rolesSnap.forEach(r=>roles.push(r.id));
  users.forEach(u=>{
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `<div><b>${u.display} (${u.username})</b><div class="muted small">Rol: <span class="role-chip">${u.role||'—'}</span> • Badge: ${u.badge||'—'}</div></div>
      <div style="text-align:right">
        <select data-uid="${u.id}" class="adm_role_sel">${roles.map(r=>`<option value="${r}" ${u.role===r?'selected':''}>${r}</option>`).join('')}</select>
        <div style="margin-top:6px"><button class="btn-ghost btn-small" data-uid="${u.id}" data-act="del">Borrar</button> <button class="btn btn-small" data-uid="${u.id}" data-act="imp">Impersonar</button></div>
      </div>`;
    ul.appendChild(div);
  });
  // attach events
  ul.querySelectorAll('.adm_role_sel').forEach(sel=>{
    sel.onchange = async (e)=>{ const uid = e.target.dataset.uid; const newRole = e.target.value; await updateDoc(doc(db,'users',uid), { role: newRole }); await logIfPrivileged(`Rol cambiado: ${uid} -> ${newRole}`); };
  });
  ul.querySelectorAll('button[data-act="del"]').forEach(b=> b.onclick = async ()=>{
    const uid = b.dataset.uid; if(!confirm('Borrar usuario?')) return;
    const userDoc = doc(db,'users',uid); const userRef = await getDoc(userDoc);
    if(userRef.exists() && userRef.data().username==='admin'){ alert('No puedes borrar admin seed'); return; }
    await deleteDoc(userDoc); await logIfPrivileged(`Usuario borrado: ${uid}`);
  });
  ul.querySelectorAll('button[data-act="imp"]').forEach(b=> b.onclick = async ()=>{
    const uid = b.dataset.uid; const d = await getDoc(doc(db,'users',uid)); if(!d.exists()) return; const u = d.data(); STATE.currentUser = {...u, _id: uid}; userDisplay.textContent = `${u.display} (${u.role})`; await logIfPrivileged(`Impersonación: ${u.username}`); alert('Ahora eres: ' + u.display);
  });
}

async function adminCreateUser(){
  // only admin can create here (frontend check)
  if(!STATE.currentUser || STATE.currentUser.role!=='admin'){ alert('Solo admin puede crear usuarios aquí'); return; }
  const username = el('adm_newUser').value.trim(); const display = el('adm_newDisplay').value.trim()||username; const pass=el('adm_newPass').value.trim()||'1234'; const role=el('adm_newRole').value;
  if(!username){ alert('username requerido'); return; }
  await addDoc(collection(db,'users'), { username, display, password:pass, role, badge:'' });
  await logIfPrivileged(`Usuario admin creado: ${username}`);
  el('adm_newUser').value=''; el('adm_newDisplay').value=''; el('adm_newPass').value='';
}

async function adminCreateRole(){
  if(!STATE.currentUser || STATE.currentUser.role!=='admin'){ alert('Solo admin puede crear roles'); return; }
  const name = el('adm_newRoleName').value.trim(); if(!name) return alert('Nombre rol requerido');
  // create role document with empty permissions
  await setDoc(doc(db,'roles',name), { name, color:'#999999', permissions:[] });
  await logIfPrivileged(`Rol creado: ${name}`);
  el('adm_newRoleName').value='';
  loadRolesAdmin();
}

async function loadRolesAdmin(){
  const rolesSnap = await getDocs(collection(db,'roles'));
  const list = []; rolesSnap.forEach(r=>list.push({id:r.id, ...r.data()}));
  const out = el('rolesAdminList'); out.innerHTML = '';
  const sel = el('adm_newRole'); sel.innerHTML = rolesSnap.docs.map(d=>`<option value="${d.id}">${d.id}</option>`).join('');
  list.forEach(r=>{
    const div = document.createElement('div'); div.className = 'item';
    div.innerHTML = `<div style="flex:1"><b>${r.id}</b><div class="muted small">Permisos: <span id="permBox_${r.id}">${(r.permissions && r.permissions.length)? r.permissions.join(', '): 'Sin permisos'}</span></div></div>
      <div style="text-align:right"><button class="btn-ghost" data-role="${r.id}" data-act="edit">Editar</button> <button class="btn" data-role="${r.id}" data-act="del">Borrar</button></div>`;
    out.appendChild(div);
  });
  // attach events
  out.querySelectorAll('button[data-act="edit"]').forEach(b=> b.onclick = ()=>{
    const key = b.dataset.role; openRoleEditor(key);
  });
  out.querySelectorAll('button[data-act="del"]').forEach(b=> b.onclick = async ()=>{
    const key = b.dataset.role; if(!confirm('Borrar rol? (Los usuarios con este rol quedarán sin rol)')) return;
    await deleteDoc(doc(db,'roles',key));
    // remove role from users
    const usersSnap = await getDocs(collection(db,'users'));
    for(const us of usersSnap.docs){
      if(us.data().role === key){
        await updateDoc(doc(db,'users',us.id), { role: '' });
      }
    }
    await logIfPrivileged(`Rol borrado: ${key}`);
    loadRolesAdmin(); renderAdmin(el('expandedRoot').firstChild);
  });
}

/* Role editor modal */
async function openRoleEditor(roleKey){
  const rref = doc(db,'roles', roleKey);
  const rdoc = await getDoc(rref);
  if(!rdoc.exists()) return alert('Rol no existe');
  const role = rdoc.data();
  // build a simple modal
  const modal = document.createElement('div'); modal.className='overlay';
  modal.innerHTML = `<div class="modal">
    <h3>Editar rol: ${roleKey}</h3>
    <div class="muted small">Marca los permisos</div>
    <div style="margin-top:12px" id="permChecks"></div>
    <div style="display:flex;gap:8px;margin-top:12px"><button id="saveRole" class="btn">Guardar</button><button id="cancelRole" class="btn-ghost">Cancelar</button></div>
  </div>`;
  document.body.appendChild(modal);
  const permsList = ['create_reports','delete_reports','create_pda','create_call','assign_call','create_bolo','manage_wanted','create_fine','export','all'];
  const box = modal.querySelector('#permChecks');
  box.innerHTML = permsList.map(p=>`<div style="margin-bottom:6px"><label><input type="checkbox" data-perm="${p}" ${role.permissions && role.permissions.includes(p)?'checked':''}/> ${p}</label></div>`).join('');
  modal.querySelector('#cancelRole').onclick = ()=> modal.remove();
  modal.querySelector('#saveRole').onclick = async () => {
    const checked = Array.from(box.querySelectorAll('input[type=checkbox]:checked')).map(c=>c.dataset.perm);
    await setDoc(rref, { name: roleKey, color: role.color || '#999999', permissions: checked });
    await logIfPrivileged(`Rol editado: ${roleKey}`);
    modal.remove();
    loadRolesAdmin(); renderAdmin(el('expandedRoot').firstChild);
  };
}

/* ================= Auditoría (logs) ================= */
function renderAudit(container){
  if(!STATE.currentUser || STATE.currentUser.role!=='admin'){ container.innerHTML = '<p>Solo accesible para admin</p>'; return; }
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Auditoría</strong><div class="muted small">Registro de acciones (solo admins)</div></div>
    <div><button class="btn btn-small" id="closeL">Cerrar</button></div>
  </div>
  <div style="margin-top:12px" id="logsList" class="list"></div>`;
  el('closeL').onclick = ()=> closeExpanded();
  onSnapshot(query(collection(db,'logs'), orderBy('created','desc')), snap=>{
    const list = el('logsList'); list.innerHTML = '';
    snap.forEach(d=>{ const ld = d.data(); 
      // show only logs created by privileged accounts (admin or sergeant) OR show all to admin
      // We store actorRole in logs; show if actorRole === 'admin' || actorRole === 'sergeant'
      if(!ld.actorRole || (ld.actorRole !== 'admin' && ld.actorRole !== 'sergeant')) return;
      const it = document.createElement('div'); it.className='item';
      it.innerHTML = `<div><div style="font-weight:700">${ld.msg}</div><div class="muted small">${new Date(ld.created).toLocaleString()}</div></div>`;
      list.appendChild(it);
    });
  });
}

/* Helper: log only when actor is privileged (admin or sergeant) */
async function logIfPrivileged(msg){
  try {
    const actorRole = STATE.currentUser ? STATE.currentUser.role : 'guest';
    // Only store logs if actor is admin or sergeant
    if(actorRole === 'admin' || actorRole === 'sergeant'){
      await addDoc(collection(db,'logs'), { msg, created: now(), actor: STATE.currentUser ? STATE.currentUser.username : 'anon', actorRole });
    }
  } catch(e){ console.error('log error',e); }
}

/* ================= Tools (export/import) ================= */
function renderTools(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Herramientas</strong><div class="muted small">Exportar / Importar (admin)</div></div>
    <div><button class="btn btn-small" id="closeT">Cerrar</button></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:8px">
    <button id="doExport" class="btn">Exportar JSON</button>
    <button id="doImport" class="btn-ghost">Importar JSON</button>
    <button id="doClear" class="btn-ghost">Borrar todo (local)</button>
  </div>
  <input id="importFile" type="file" style="display:none" accept=".json" />`;
  el('closeT').onclick = ()=> closeExpanded();
  el('doExport').onclick = exportAll;
  el('doImport').onclick = ()=> el('importFile').click();
  el('doClear').onclick = ()=>{ if(confirm('Borrar todos los datos locales? (no afecta Firestore)')) { localStorage.clear(); alert('localStorage borrado'); } };
  el('importFile').onchange = importFile;
}
async function exportAll(){
  // Only admin can export
  if(!STATE.currentUser || STATE.currentUser.role !== 'admin') return alert('Solo admin puede exportar');
  const data = {};
  const collections = ['users','roles','reports','pda','calls','fines','wanted','logs','onDuty'];
  for(const c of collections){
    const snap = await getDocs(collection(db,c));
    data[c] = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }
  const blob = new Blob([JSON.stringify(data,null,2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `pda_export_${Date.now()}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  await logIfPrivileged(`Exportado datos por ${STATE.currentUser.username}`);
}
function importFile(evt){
  const f = evt.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = async (ev)=>{
    try{
      const data = JSON.parse(ev.target.result);
      if(!confirm('Importar reemplazará/añadirá datos. ¿Continuar?')) return;
      // naive import: set documents with random IDs
      for(const collName in data){
        const arr = data[collName];
        if(!Array.isArray(arr)) continue;
        for(const item of arr){
          // if item has id and collName is roles/users maybe keep id; else add new doc
          await addDoc(collection(db, collName), item);
        }
      }
      alert('Importación enviada a Firestore (puede tardar en verse).');
      await logIfPrivileged(`Importación de JSON realizada por ${STATE.currentUser ? STATE.currentUser.username : 'anon'}`);
    } catch(e){ alert('JSON inválido'); console.error(e); }
  };
  reader.readAsText(f);
}

/* ================= Login / Register (preserve your original modal flow) ================= */
btnLogin.addEventListener('click', ()=>{
  if(STATE.currentUser){
    if(confirm('Cerrar sesión?')){ STATE.currentUser = null; userDisplay.textContent = 'No conectado'; el('btnLogin').textContent = 'Iniciar sesión'; }
  } else {
    openLoginModal();
  }
});

function openLoginModal(){ loginModal.style.display='flex'; el('loginUser').focus(); }
function closeLoginModal(){ loginModal.style.display='none'; el('loginPass').value=''; el('loginUser').value=''; el('loginError').style.display='none'; }

el('loginBtnModal').onclick = async ()=>{
  const u = el('loginUser').value.trim(); const p = el('loginPass').value.trim();
  if(!u || !p){ el('loginError').style.display='block'; el('loginError').textContent='Introduce usuario y contraseña'; return; }
  // query users collection for match
  const snap = await getDocs(collection(db,'users'));
  let foundDoc = null;
  snap.forEach(d => { const dt = d.data(); if(dt.username === u && dt.password === p) foundDoc = { id: d.id, data: dt }; });
  if(foundDoc){
    const user = {...foundDoc.data, _id: foundDoc.id};
    STATE.currentUser = user;
    userDisplay.textContent = `${user.display} (${user.role})`;
    el('btnLogin').textContent = 'Perfil';
    closeLoginModal();
    await logIfPrivileged(`Sesión iniciada: ${user.username}`);
  } else {
    el('loginError').style.display = 'block';
    el('loginError').textContent = 'Usuario o contraseña incorrectos';
  }
};

el('guestBtn').onclick = ()=> { STATE.currentUser = null; userDisplay.textContent = 'Invitado'; closeLoginModal(); };

el('showReg').onclick = ()=> { const b = el('registerBlock'); b.style.display = b.style.display==='none' ? 'block' : 'none'; };
el('regCancel').onclick = ()=> { el('registerBlock').style.display='none'; };

el('regCreate').onclick = async ()=>{
  const username = el('regUser').value.trim(); const display = el('regName').value.trim() || username;
  const pass = el('regPass').value.trim() || '1234'; const role = el('regRole').value;
  if(!username){ el('regMsg').textContent='Usuario requerido'; return; }
  // check exist
  const snap = await getDocs(collection(db,'users'));
  let exists = false;
  snap.forEach(d => { if(d.data().username === username) exists = true; });
  if(exists){ el('regMsg').textContent='Usuario ya existe'; return; }
  await addDoc(collection(db,'users'), { username, display, password:pass, role, badge:'' });
  el('regMsg').textContent='Cuenta creada. Inicia sesión.';
  await logIfPrivileged(`Cuenta creada: ${username}`);
  el('regUser').value=''; el('regName').value=''; el('regPass').value='';
};

/* ================= Helpers UI ================= */
function closeExpanded(){ expandedRoot.innerHTML=''; window.scrollTo({top:0,behavior:'smooth'}); }
function updateHeader(){
  userDisplay.textContent = STATE.currentUser ? `${STATE.currentUser.display} (${STATE.currentUser.role})` : 'No conectado';
  // duty count update handled by snapshot on onDuty
}
el('btnExport').onclick = async ()=> {
  // open tools panel if admin
  openCard('tools');
};

/* ================= Init ================= */
function initUI(){
  renderCards();
  // Ensure collections 'roles' contains some seeds if missing (only client-side helper)
  (async ()=>{
    const rolesSnap = await getDocs(collection(db,'roles'));
    if(rolesSnap.empty){
      // create default roles
      await setDoc(doc(db,'roles','officer'), { name:'Officer', color:'#7c3aed', permissions:['create_reports','create_pda','create_call'] });
      await setDoc(doc(db,'roles','sergeant'), { name:'Sergeant', color:'#3b82f6', permissions:['create_reports','create_pda','create_call','delete_reports'] });
      await setDoc(doc(db,'roles','dispatcher'), { name:'Dispatcher', color:'#f97316', permissions:['create_call','assign_call'] });
      await setDoc(doc(db,'roles','admin'), { name:'Admin', color:'#10b981', permissions:['all'] });
    }
    // seed admin user if no users exist
    const usersSnap = await getDocs(collection(db,'users'));
    if(usersSnap.empty){
      await addDoc(collection(db,'users'), { username:'admin', display:'Admin', password:'admin123', role:'admin', badge:'ADM-001' });
      await addDoc(collection(db,'users'), { username:'perety04', display:'Perety 04', password:'peretypass', role:'officer', badge:'PD-314' });
    }
  })();
  // subscribe to onDuty for header update
  onSnapshot(collection(db,'onDuty'), snap=>{
    let count = 0;
    snap.forEach(d => { if(d.data().on) count++; });
    dutyStatus.textContent = `En servicio: ${count}`;
  });
}
initUI();

</script>
</body>
</html>
