<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wizard RP — Sistema Policial</title>
  <style>
    :root {
      --accent: #844ffc;
      --bg: #0a0f1a;
      --panel: #111a2b;
      --panel-light: #18253d;
      --text: #f1f1f1;
      --muted: #9ba6b2;
    }
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header {
      background: var(--panel);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      border-bottom: 2px solid var(--accent);
    }
    header .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    header .logo img { height: 48px; }
    header h1 { font-size: 20px; margin: 0; }
    .btn {
      background: var(--accent);
      border: none;
      border-radius: 10px;
      padding: 8px 14px;
      font-weight: bold;
      color: white;
      cursor: pointer;
      transition: 0.2s;
    }
    .btn:hover { opacity: 0.9; transform: scale(1.05); }
    .btn-ghost {
      background: transparent;
      border: 2px solid var(--accent);
      border-radius: 10px;
      padding: 8px 14px;
      font-weight: bold;
      color: var(--accent);
      cursor: pointer;
      transition: 0.2s;
    }
    .btn-ghost:hover { background: var(--accent); color: white; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      padding: 20px;
    }
    .card {
      background: var(--panel);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: 0.3s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .card:hover { transform: translateY(-5px); background: var(--panel-light); }
    .card h3 { margin: 10px 0; font-size: 20px; }
    .card p { color: var(--muted); font-size: 14px; }
    .expanded {
      margin: 20px;
      background: var(--panel);
      padding: 20px;
      border-radius: 16px;
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    input, textarea, select {
      width: 100%; padding: 8px; margin: 6px 0;
      border-radius: 8px; border: 1px solid #2c3e50;
      background: #0d1625; color: white;
    }
    .list { margin-top: 12px; display: flex; flex-direction: column; gap: 8px; }
    .item {
      padding: 10px; background: var(--panel-light);
      border-radius: 10px; display: flex;
      justify-content: space-between; align-items: center;
    }
    .item small { color: var(--muted); }
    footer { text-align: center; padding: 12px; color: var(--muted); font-size: 13px; }
    /* MODAL LOGIN */
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.8);
      display: flex; align-items: center; justify-content: center; z-index: 1000;
    }
    .modal {
      background: var(--panel); padding: 20px; border-radius: 12px;
      width: 420px; max-width: 95%; box-shadow: 0 4px 16px rgba(0,0,0,0.6);
      animation: fadeIn 0.2s ease-in-out;
    }
    .modal h3 { margin-top: 0; }
    /* Avisos emergentes */
    #avisosBox {
      position: fixed; top: 20px; right: 20px;
      display: flex; flex-direction: column; gap: 10px;
      z-index: 2000;
    }
    .aviso {
      background: var(--panel-light); padding: 12px 18px;
      border-left: 5px solid var(--accent);
      border-radius: 8px; min-width: 220px;
      box-shadow: 0 4px 10px rgba(0,0,0,.5);
      animation: fadeIn 0.3s ease-in-out;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="https://cdn.discordapp.com/attachments/1421898595271180360/1422217488145453219/LOGO_WIZARD_FONDO.png.png" alt="Wizard RP Logo">
      <h1>Wizard RP — Sistema Policial</h1>
    </div>
    <div>
      <span id="userDisplay">Invitado</span>
      <button id="btnLogin" class="btn-ghost">Iniciar Sesión</button>
    </div>
  </header>

  <section class="grid" id="cardsRoot"></section>
  <div id="expandedRoot"></div>
  <footer>Wizard RP — Sistema Policial Online</footer>

  <div id="avisosBox"></div>

  <!-- Modal login -->
  <div id="loginModal" class="overlay" style="display:none">
    <div class="modal">
      <h3>Iniciar Sesión</h3>
      <input id="loginUser" placeholder="Usuario">
      <input id="loginPass" type="password" placeholder="Contraseña">
      <button id="loginBtn" class="btn">Entrar</button>
      <p id="loginError" style="color:red"></p>
    </div>
  </div>
<!-- ------------------ PARTE 2: JS (Firebase + Lógica) ------------------ -->
<script type="module">
/*
  Wizard RP - JS (Parte 2)
  - Usa Firestore para datos compartidos en tiempo real entre dispositivos
  - Login simple: usuarios almacenados en collection 'users' (contraseñas en claro en demo)
  - Solo admins pueden crear usuarios desde el panel de administración
  - Avisos emergentes para llamadas, asignaciones y cambios de servicio
  - Auditoría guardada en 'audit'
  - Prefijos/colecciones: users, pda, reports, calls, wanted, fines, roles, audit, onDuty, incautaciones, alertas
*/

/* =========== Firebase init =========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, onSnapshot, doc, setDoc, updateDoc,
  deleteDoc, serverTimestamp, getDoc, query, where, orderBy
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCskczYgGtlPPBEIZiE5PuY7s_cfE_3Chg",
  authDomain: "wizard-rp.firebaseapp.com",
  projectId: "wizard-rp",
  storageBucket: "wizard-rp.firebasestorage.app",
  messagingSenderId: "479456044047",
  appId: "1:479456044047:web:65c52e2430bcb6ca586f7a",
  measurementId: "G-KX5Y56CG0R"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =========== Estado local =========== */
let STATE = {
  currentUser: null,       // {id, username, display, role, ...}
  impersonator: null,      // si admin está suplantando, guarda admin original aquí
  listeners: []            // para desconectar listeners si se necesita
};

/* =========== Utilidades UI =========== */
const cardsRoot = document.getElementById('cardsRoot');
const expandedRoot = document.getElementById('expandedRoot');
const userDisplay = document.getElementById('userDisplay');
const loginModal = document.getElementById('loginModal');
const loginError = document.getElementById('loginError');
const avisosBox = document.getElementById('avisosBox');

function showAviso(text, ttl = 6000){
  const el = document.createElement('div');
  el.className = 'aviso';
  el.textContent = text;
  avisosBox.appendChild(el);
  setTimeout(()=> el.remove(), ttl);
}

/* ========== Registro de auditoría ========== */
async function pushAudit(action, meta = {}){
  try{
    await addDoc(collection(db,'audit'), {
      action, actor: STATE.currentUser ? STATE.currentUser.display : 'Invitado',
      ts: serverTimestamp(), ...meta
    });
  }catch(e){ console.warn('audit err', e); }
}

/* ========== Permisos y roles (cliente) ========== */
async function loadRoles(){
  const snap = await getDocs(collection(db,'roles'));
  const r = {};
  snap.forEach(d=> r[d.id] = d.data());
  return r;
}
async function hasPerm(perm){
  if(!STATE.currentUser) return perm === 'create_call'; // invitados pueden crear llamada
  // load role from roles collection
  const roleDoc = await getDoc(doc(db,'roles',STATE.currentUser.role || ''));
  if(!roleDoc.exists()) return false;
  const role = roleDoc.data();
  if(role.permissions && role.permissions.includes('all')) return true;
  return role.permissions && role.permissions.includes(perm);
}

/* ========== Render tarjetas principales ========== */
const CARDS = [
  {id:'pda', title:'PDA', desc:'Buscar/crear fichas'},
  {id:'reports', title:'Informes', desc:'Crear y ver informes'},
  {id:'calls', title:'Llamadas', desc:'Crear/Asignar llamadas'},
  {id:'wanted', title:'BOLO / Wanted', desc:'Fichas buscadas'},
  {id:'fines', title:'Multas', desc:'Emitir sanciones'},
  {id:'service', title:'Servicio', desc:'Entrar/Salir servicio'},
  {id:'incautaciones', title:'Incautaciones', desc:'Vehículos incautados'},
  {id:'alertas', title:'Alertas', desc:'Ver/Crear alertas ciudadanas'},
  {id:'admin', title:'Administración', desc:'Usuarios y roles'},
  {id:'audit', title:'Auditoría', desc:'Historial (admin/sargento)'}
];

function renderCards(){
  cardsRoot.innerHTML = '';
  CARDS.forEach(c=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `<h3 style="color:#fff">${c.title}</h3><p>${c.desc}</p>`;
    card.onclick = ()=> openCard(c.id);
    cardsRoot.appendChild(card);
  });
}

/* ========== Open card router ========== */
function openCard(id){
  expandedRoot.innerHTML = '';
  if(id === 'pda') renderPDA();
  else if(id === 'reports') renderReports();
  else if(id === 'calls') renderCalls();
  else if(id === 'wanted') renderWanted();
  else if(id === 'fines') renderFines();
  else if(id === 'service') renderService();
  else if(id === 'incautaciones') renderIncautaciones();
  else if(id === 'alertas') renderAlertas();
  else if(id === 'admin') {
    if(!STATE.currentUser || STATE.currentUser.role !== 'admin'){
      showAviso('Acceso denegado: solo administradores.',5000); return;
    }
    renderAdmin();
  }
  else if(id === 'audit') {
    if(!STATE.currentUser) { showAviso('Acceso denegado',4000); return; }
    // only admin or sergeant
    if(['admin','sergeant'].includes(STATE.currentUser.role)) renderAudit();
    else showAviso('Acceso denegado: permisos insuficientes',4000);
  }
}

/* ========== LOGIN (solo inicio) ========== */
document.getElementById('btnLogin').onclick = () => loginModal.style.display = 'flex';
document.getElementById('loginBtn').onclick = async ()=>{
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  loginError.textContent = '';
  if(!u || !p){ loginError.textContent = 'Introduce usuario y contraseña'; return; }
  const snap = await getDocs(collection(db,'users'));
  let found = null;
  snap.forEach(d=>{
    const data = d.data();
    if(data.username === u && data.password === p){ found = {id: d.id, ...data}; }
  });
  if(!found){ loginError.textContent = 'Usuario o contraseña incorrectos'; return; }
  STATE.currentUser = found;
  // if admin was impersonating another, ensure correct behavior
  updateHeader();
  loginModal.style.display = 'none';
  await pushAudit(`Sesión iniciada: ${found.username}`, {uid: found.id});
  showAviso(`Sesión: ${found.display} (${found.role})`,5000);
  setupRealtime(); // (re)connect listeners if needed
};

/* ========== Header update and real-time setup ========== */
function updateHeader(){
  userDisplay.textContent = STATE.currentUser ? `${STATE.currentUser.display} (${STATE.currentUser.role})` : 'Invitado';
  // update onDuty count
  getDocs(collection(db,'onDuty')).then(snap=>{
    let count = 0;
    snap.forEach(d =>{ const v = d.data(); if(v.active) count++; });
    const txt = STATE.currentUser ? `${STATE.currentUser.display} • En servicio: ${count}` : `Invitado • En servicio: ${count}`;
    userDisplay.textContent = STATE.currentUser ? `${STATE.currentUser.display} (${STATE.currentUser.role})` : `Invitado • En servicio: ${count}`;
  });
}

/* ========== Realtime listeners (to show live changes, notifications) ========== */
let unsubscribers = [];
function cleanupRealtime(){
  unsubscribers.forEach(u => { try{ u(); }catch(e){} });
  unsubscribers = [];
}
function setupRealtime(){
  cleanupRealtime();
  // Listen for new calls -> avisos
  const callsCol = collection(db,'calls');
  const qCalls = query(callsCol, orderBy('created_at','desc'));
  const unsubCalls = onSnapshot(qCalls, snap=>{
    snap.docChanges().forEach(ch=>{
      if(ch.type === 'added'){
        const data = ch.doc.data();
        // show aviso for new call only if created recently (<7s) to avoid historic ones showing on reconnect
        const created = data.created_at ? data.created_at.toDate().getTime() : Date.now();
        if(Date.now() - created < 8000) showAviso(`Nueva llamada: ${data.caller} — ${data.message}`,7000);
      }
      if(ch.type === 'modified'){
        const data = ch.doc.data();
        // if assigned recently -> aviso
        if(data.assigned_changed_recently) showAviso(`Llamada asignada: ${data.caller} → ${data.assigned_to_name || 'unidad'}`,7000);
      }
    });
    // refresh current open calls view if needed
    if(STATE.expanded === 'calls') loadCalls();
  });
  unsubscribers.push(unsubCalls);

  // Listen for onDuty changes -> avisos
  const unsubDuty = onSnapshot(collection(db,'onDuty'), snap=>{
    snap.docChanges().forEach(ch=>{
      if(ch.type === 'modified' || ch.type === 'added'){
        const d = ch.doc.data();
        // aviso cuando active cambie
        if(d.just_changed_recently){
          if(d.active) showAviso(`${d.display} se ha puesto en servicio`,5000);
          else {
            const from = d.start_ts ? new Date(d.start_ts.toDate()).toLocaleString() : 'desconocido';
            const to = d.end_ts ? new Date(d.end_ts.toDate()).toLocaleString() : 'ahora';
            showAviso(`${d.display} ha salido de servicio (desde ${from} hasta ${to})`,7000);
          }
        }
      }
    });
    if(STATE.expanded === 'service') loadDutyList();
  });
  unsubscribers.push(unsubDuty);

  // Live updates for PDAs, reports, wanted etc: refresh views if open
  const unsubPDA = onSnapshot(collection(db,'pda'), snap => { if(STATE.expanded === 'pda') loadPDA(); });
  const unsubReports = onSnapshot(collection(db,'reports'), snap => { if(STATE.expanded === 'reports') loadReports(); });
  const unsubWanted = onSnapshot(collection(db,'wanted'), snap => { if(STATE.expanded === 'wanted') loadWanted(); });
  const unsubFines = onSnapshot(collection(db,'fines'), snap => { if(STATE.expanded === 'fines') loadFines(); });
  unsubscribers.push(unsubPDA, unsubReports, unsubWanted, unsubFines);
}

/* ========== PDA module ========== */
function renderPDA(){
  STATE.expanded = 'pda';
  expandedRoot.innerHTML = `<div class="expanded">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>PDA / Fichas</strong><div class="muted">Buscar y crear fichas</div></div>
      <div><button class="btn" id="closeP">Cerrar</button></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:12px">
      <div style="flex:1">
        <input id="pdaQ" placeholder="Buscar por nombre o texto..."/>
        <div id="pdaList" class="list" style="margin-top:8px"></div>
      </div>
      <div style="width:380px">
        <div class="muted small">Plantilla</div>
        <textarea id="pdaTpl" style="min-height:160px"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="pdaCreateBtn" class="btn">Crear ficha</button>
          <button id="pdaClearBtn" class="btn-ghost">Limpiar</button>
        </div>
      </div>
    </div>
  </div>`;
  document.getElementById('closeP').onclick = ()=> closeExpanded();
  document.getElementById('pdaQ').oninput = ()=> searchPDA(document.getElementById('pdaQ').value);
  document.getElementById('pdaCreateBtn').onclick = createPDA;
  loadPDA(); // initial load
}
async function loadPDA(){
  const listEl = document.getElementById('pdaList');
  const snap = await getDocs(collection(db,'pda'));
  listEl.innerHTML = '';
  if(snap.empty){ listEl.innerHTML = '<div class="muted small">Sin fichas</div>'; return; }
  snap.forEach(d=>{
    const p = d.data();
    const item = document.createElement('div'); item.className = 'item';
    const left = document.createElement('div'); left.style.flex = '1';
    left.innerHTML = `<b>${p.title||'Ficha'}</b><div class="muted small">${(p.text||'').slice(0,120)}</div>`;
    const right = document.createElement('div');
    // only author or admins can delete
    let delBtn = `<button class="btn-ghost" data-id="${d.id}" data-act="view">Ver</button>`;
    if(STATE.currentUser && (STATE.currentUser.role === 'admin' || STATE.currentUser.username === p.author)){
      delBtn += ` <button class="btn" data-id="${d.id}" data-act="del">Borrar</button>`;
    }
    right.innerHTML = delBtn;
    item.appendChild(left); item.appendChild(right);
    listEl.appendChild(item);
  });
  // attach events
  listEl.querySelectorAll('button[data-act="view"]').forEach(b=> b.onclick = async (e)=>{
    const id = b.dataset.id;
    const d = await getDoc(doc(db,'pda',id));
    const p = d.data();
    alert(`Ficha: ${p.title}\n\n${p.text}\n\nAutor: ${p.author}\nCreado: ${p.created_at?.toDate?.()?.toLocaleString?.() || '—'}`);
  });
  listEl.querySelectorAll('button[data-act="del"]').forEach(b=> b.onclick = async (e)=>{
    if(!confirm('Borrar ficha PDA?')) return;
    const id = b.dataset.id;
    await deleteDoc(doc(db,'pda',id));
    await pushAudit(`Ficha PDA borrada (${id})`);
    showAviso('Ficha borrada');
  });
}
async function searchPDA(q){
  q = (q||'').toLowerCase().trim();
  if(!q) return loadPDA();
  const snap = await getDocs(collection(db,'pda'));
  const listEl = document.getElementById('pdaList'); listEl.innerHTML = '';
  snap.forEach(d=>{
    const p = d.data();
    if((p.text||'').toLowerCase().includes(q) || (p.title||'').toLowerCase().includes(q)){
      const item = document.createElement('div'); item.className='item';
      item.innerHTML = `<div style="flex:1"><b>${p.title||'Ficha'}</b><div class="muted small">${(p.text||'').slice(0,120)}</div></div>
        <div><button class="btn-ghost" data-id="${d.id}" data-act="view">Ver</button></div>`;
      listEl.appendChild(item);
    }
  });
  listEl.querySelectorAll('button[data-act="view"]').forEach(b=> b.onclick = async ()=> {
    const id=b.dataset.id; const d = await getDoc(doc(db,'pda',id)); const p = d.data();
    alert(`Ficha: ${p.title}\n\n${p.text}`);
  });
}
async function createPDA(){
  if(!STATE.currentUser){ showAviso('Debes iniciar sesión para crear fichas'); return; }
  const tpl = document.getElementById('pdaTpl').value.trim();
  if(!tpl){ alert('Rellena la plantilla'); return; }
  const title = (tpl.split('\n')[0] || 'Ficha').replace('Nombre:','').trim();
  await addDoc(collection(db,'pda'), {
    title, text: tpl, author: STATE.currentUser.username, created_at: serverTimestamp()
  });
  await pushAudit(`Ficha PDA creada: ${title}`);
  showAviso('Ficha creada');
  document.getElementById('pdaTpl').value = '';
  loadPDA();
}

/* ========== REPORTS module ========== */
function renderReports(){
  STATE.expanded = 'reports';
  expandedRoot.innerHTML = `<div class="expanded">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Informes</strong><div class="muted">Crear y consultar informes</div></div>
      <div><button class="btn" id="closeR">Cerrar</button></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:12px">
      <div style="flex:1">
        <input id="repTitle" placeholder="Título"/>
        <textarea id="repDesc" placeholder="Descripción..."></textarea>
        <div style="display:flex;gap:8px"><button id="repSave" class="btn">Guardar informe</button></div>
      </div>
      <div style="width:360px">
        <div class="muted small">Últimos informes</div>
        <div id="repList" class="list" style="margin-top:8px"></div>
      </div>
    </div>
  </div>`;
  document.getElementById('closeR').onclick = ()=> closeExpanded();
  document.getElementById('repSave').onclick = saveReport;
  loadReports();
}
async function saveReport(){
  if(!STATE.currentUser){ showAviso('Debes iniciar sesión para crear informes'); return; }
  const title = document.getElementById('repTitle').value.trim();
  const desc = document.getElementById('repDesc').value.trim();
  if(!title || !desc){ alert('Título y descripción obligatorios'); return; }
  await addDoc(collection(db,'reports'), {
    title, description: desc, author: STATE.currentUser.display, created_at: serverTimestamp()
  });
  await pushAudit(`Informe creado: ${title}`);
  showAviso('Informe creado');
  document.getElementById('repTitle').value=''; document.getElementById('repDesc').value='';
  loadReports();
}
async function loadReports(){
  const snap = await getDocs(collection(db,'reports'));
  const list = document.getElementById('repList'); list.innerHTML = '';
  if(snap.empty){ list.innerHTML = '<div class="muted small">Sin informes</div>'; return; }
  snap.forEach(d=>{
    const r = d.data();
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div style="flex:1"><b>${r.title}</b><div class="muted small">${(r.description||'').slice(0,160)}</div></div>
      <div style="text-align:right"><small>${r.author||''}</small><div>${r.created_at ? new Date(r.created_at.toDate()).toLocaleString() : ''}</div>
      <div style="margin-top:6px"><button class="btn-ghost" data-id="${d.id}" data-act="view">Ver</button>
      ${(STATE.currentUser && (STATE.currentUser.role==='admin' || STATE.currentUser.role==='sergeant' || (r.author===STATE.currentUser.display))) ? `<button class="btn" data-id="${d.id}" data-act="del">Borrar</button>` : ''}</div></div>`;
    list.appendChild(it);
  });
  list.querySelectorAll('button[data-act="view"]').forEach(b=> b.onclick = async ()=>{
    const d = await getDoc(doc(db,'reports', b.dataset.id));
    const r = d.data();
    alert(`Informe: ${r.title}\n\n${r.description}\n\nAutor: ${r.author}`);
  });
  list.querySelectorAll('button[data-act="del"]').forEach(b=> b.onclick = async ()=>{
    if(!confirm('Borrar informe?')) return;
    await deleteDoc(doc(db,'reports', b.dataset.id));
    await pushAudit(`Informe borrado: ${b.dataset.id}`);
    loadReports();
  });
}

/* ========== CALLS module (dispatch) ========== */
function renderCalls(){
  STATE.expanded = 'calls';
  expandedRoot.innerHTML = `<div class="expanded">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Dispatch / Llamadas</strong><div class="muted">Crear llamadas y asignar unidades</div></div>
      <div><button class="btn" id="closeC">Cerrar</button></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:12px">
      <div style="flex:1">
        <input id="callFrom" placeholder="Remitente"/>
        <input id="callMsg" placeholder="Mensaje"/>
        <div style="display:flex;gap:8px;margin-top:8px"><button id="callCreateBtn" class="btn">Crear llamada</button></div>
        <div style="margin-top:12px"><strong>Llamadas</strong><div id="callsList" class="list"></div></div>
      </div>
      <div style="width:320px">
        <div class="muted small">Unidades en servicio</div>
        <div id="callsUnits" class="list" style="margin-top:8px"></div>
      </div>
    </div>
  </div>`;
  document.getElementById('closeC').onclick = ()=> closeExpanded();
  document.getElementById('callCreateBtn').onclick = createCall;
  loadCalls();
  loadUnitsServiceForAssign();
}
async function createCall(){
  const caller = document.getElementById('callFrom').value.trim() || 'Anónimo';
  const message = document.getElementById('callMsg').value.trim();
  if(!message){ alert('Mensaje requerido'); return; }
  const docRef = await addDoc(collection(db,'calls'), {
    caller, message, status: 'pending', assigned_to: null, created_at: serverTimestamp()
  });
  await pushAudit(`Llamada creada: ${caller} — ${message}`);
  showAviso('Llamada creada');
  document.getElementById('callFrom').value=''; document.getElementById('callMsg').value='';
  // loadCalls will update via realtime listener
}
async function loadCalls(){
  const snap = await getDocs(collection(db,'calls'));
  const list = document.getElementById('callsList'); list.innerHTML = '';
  if(snap.empty){ list.innerHTML = '<div class="muted small">No hay llamadas</div>'; return; }
  const usersSnap = await getDocs(collection(db,'users'));
  const usersMap = {};
  usersSnap.forEach(d=> usersMap[d.id] = d.data());
  snap.forEach(d=>{
    const c = d.data();
    const item = document.createElement('div'); item.className='item';
    const assigneeName = c.assigned_to ? (usersMap[c.assigned_to]?.display || '—') : '—';
    item.innerHTML = `<div style="flex:1"><b>${c.caller}</b><div class="muted small">${c.message}</div></div>
      <div style="text-align:right"><small>${c.created_at ? new Date(c.created_at.toDate()).toLocaleString() : ''}</small><div style="margin-top:6px" class="muted small">Asig: ${assigneeName}</div>
      <div style="margin-top:8px">
        ${ STATE.currentUser && (await hasPerm('assign_call')) ? `<button class="btn-ghost" data-id="${d.id}" data-act="assign">Asignar a mí</button>` : '' }
        ${ STATE.currentUser && (STATE.currentUser.role==='admin' || c.assigned_to === STATE.currentUser.id) ? `<button class="btn" data-id="${d.id}" data-act="del">Borrar</button>` : '' }
      </div></div>`;
    list.appendChild(item);
  });
  // attach buttons
  list.querySelectorAll('button[data-act="assign"]').forEach(b=> b.onclick = async ()=>{
    if(!STATE.currentUser){ showAviso('Inicia sesión para asignar'); return; }
    const id = b.dataset.id;
    // set assigned_to and mark a flag to trigger assignment notification
    await updateDoc(doc(db,'calls', id), { assigned_to: STATE.currentUser.id, status: 'assigned', assigned_at: serverTimestamp() });
    await pushAudit(`Llamada ${id} asignada a ${STATE.currentUser.display}`);
    showAviso('Llamada asignada a ti');
  });
  list.querySelectorAll('button[data-act="del"]').forEach(b=> b.onclick = async ()=>{
    if(!confirm('Borrar llamada?')) return;
    await deleteDoc(doc(db,'calls', b.dataset.id));
    await pushAudit(`Llamada borrada: ${b.dataset.id}`);
    loadCalls();
  });
}
async function loadUnitsServiceForAssign(){
  // show list of users in onDuty active
  const snap = await getDocs(collection(db,'onDuty'));
  const list = document.getElementById('callsUnits'); list.innerHTML = '';
  let any = false;
  snap.forEach(d=>{
    const od = d.data();
    if(od.active){
      any = true;
      const el = document.createElement('div'); el.className = 'item'; el.textContent = `${od.display} • ${od.role || ''}`;
      list.appendChild(el);
    }
  });
  if(!any) list.innerHTML = '<div class="muted small">Nadie en servicio</div>';
}

/* ========== WANTED (BOLO) ========== */
function renderWanted(){
  STATE.expanded = 'wanted';
  expandedRoot.innerHTML = `<div class="expanded">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>BOLO / Wanted</strong><div class="muted">Crear fichas buscadas</div></div>
      <div><button class="btn" id="closeW">Cerrar</button></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:12px">
      <div style="flex:1">
        <input id="wName" placeholder="Nombre / Alias"/>
        <input id="wBounty" placeholder="Recompensa"/>
        <textarea id="wDesc" placeholder="Descripción"></textarea>
        <div style="display:flex;gap:8px"><button id="wCreate" class="btn">Crear ficha</button></div>
      </div>
      <div style="width:320px">
        <div class="muted small">Fichas</div>
        <div id="wantedList" class="list"></div>
      </div>
    </div>
  </div>`;
  document.getElementById('closeW').onclick = ()=> closeExpanded();
  document.getElementById('wCreate').onclick = createWanted;
  loadWanted();
}
async function createWanted(){
  if(!STATE.currentUser){ showAviso('Login requerido'); return; }
  if(!await hasPerm('create_bolo')){ showAviso('Permiso denegado'); return; }
  const name = document.getElementById('wName').value.trim();
  const desc = document.getElementById('wDesc').value.trim();
  const bounty = parseInt(document.getElementById('wBounty').value||'0',10) || 0;
  if(!name){ alert('Nombre requerido'); return; }
  await addDoc(collection(db,'wanted'), { name, description: desc, bounty, created_at: serverTimestamp(), author: STATE.currentUser.display });
  await pushAudit(`Wanted creado: ${name}`);
  showAviso('Wanted creado');
  loadWanted();
}
async function loadWanted(){
  const snap = await getDocs(collection(db,'wanted'));
  const list = document.getElementById('wantedList'); list.innerHTML = '';
  if(snap.empty){ list.innerHTML = '<div class="muted small">Sin fichas</div>'; return; }
  snap.forEach(d=>{
    const w = d.data();
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div style="flex:1"><b>${w.name}</b><div class="muted small">${w.description}</div></div><div>${w.bounty||0}€</div>`;
    list.appendChild(it);
  });
}

/* ========== FINES module ========== */
function renderFines(){
  STATE.expanded = 'fines';
  expandedRoot.innerHTML = `<div class="expanded">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Multas</strong><div class="muted">Generar sanciones</div></div>
      <div><button class="btn" id="closeF">Cerrar</button></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:12px">
      <div style="flex:1">
        <input id="fineOff" placeholder="Infractor (vehículo/nombre)"/>
        <input id="fineAmt" placeholder="Importe"/>
        <textarea id="fineReason" placeholder="Motivo..."></textarea>
        <div style="display:flex;gap:8px"><button id="fineSave" class="btn">Emitir multa</button></div>
      </div>
      <div style="width:320px">
        <div class="muted small">Historial multas</div>
        <div id="finesList" class="list"></div>
      </div>
    </div>
  </div>`;
  document.getElementById('closeF').onclick = ()=> closeExpanded();
  document.getElementById('fineSave').onclick = saveFine;
  loadFines();
}
async function saveFine(){
  if(!STATE.currentUser){ showAviso('Login requerido'); return; }
  if(!await hasPerm('create_fine')){ showAviso('Permiso denegado para crear multas'); return; }
  const off = document.getElementById('fineOff').value.trim();
  const amt = parseInt(document.getElementById('fineAmt').value||'0',10) || 0;
  const reason = document.getElementById('fineReason').value.trim();
  if(!off || !amt){ alert('Infractor e importe requeridos'); return; }
  await addDoc(collection(db,'fines'), { offender:off, amount:amt, reason, author: STATE.currentUser.display, created_at: serverTimestamp() });
  await pushAudit(`Multa creada: ${off} ${amt}€`);
  showAviso('Multa creada');
  loadFines();
}
async function loadFines(){
  const snap = await getDocs(collection(db,'fines'));
  const list = document.getElementById('finesList'); list.innerHTML = '';
  if(snap.empty){ list.innerHTML = '<div class="muted small">Sin multas</div>'; return; }
  snap.forEach(d=>{
    const f = d.data();
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div style="flex:1"><b>${f.offender} • ${f.amount}€</b><div class="muted small">${f.reason}</div></div><div>${f.created_at ? new Date(f.created_at.toDate()).toLocaleString() : ''}</div>`;
    list.appendChild(it);
  });
}

/* ========== SERVICE (on-duty) ========== */
function renderService(){
  STATE.expanded = 'service';
  expandedRoot.innerHTML = `<div class="expanded">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Servicio</strong><div class="muted">Ponte en servicio o sal</div></div>
      <div><button class="btn" id="closeS">Cerrar</button></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:12px;align-items:center">
      <div class="muted small">Tu estado:</div><div id="serviceBox" class="item">Desconocido</div>
      <div style="margin-left:auto"><button id="toggleDuty" class="btn">Cambiar estado</button></div>
    </div>
    <div style="margin-top:12px"><strong>Policías en servicio</strong><div id="dutyList" class="list" style="margin-top:8px"></div></div>
  </div>`;
  document.getElementById('closeS').onclick = ()=> closeExpanded();
  document.getElementById('toggleDuty').onclick = toggleDuty;
  loadDutyList();
}
async function toggleDuty(){
  if(!STATE.currentUser){ showAviso('Inicia sesión'); return; }
  const uid = STATE.currentUser.id;
  const ref = doc(db,'onDuty',uid);
  const snap = await getDoc(ref);
  if(!snap.exists()){
    // start duty
    await setDoc(ref, { uid, display: STATE.currentUser.display, role: STATE.currentUser.role, active: true, start_ts: serverTimestamp(), just_changed_recently: true });
    await pushAudit(`${STATE.currentUser.display} entró en servicio`);
  } else {
    const data = snap.data();
    if(data.active){
      // end duty
      await updateDoc(ref, { active: false, end_ts: serverTimestamp(), just_changed_recently: true });
      await pushAudit(`${STATE.currentUser.display} salió de servicio`);
    } else {
      // reactivate
      await updateDoc(ref, { active: true, start_ts: serverTimestamp(), just_changed_recently: true });
      await pushAudit(`${STATE.currentUser.display} entró en servicio`);
    }
  }
  loadDutyList();
}
async function loadDutyList(){
  const snap = await getDocs(collection(db,'onDuty'));
  const list = document.getElementById('dutyList'); list.innerHTML = '';
  let active = [];
  snap.forEach(d=>{
    const od = d.data();
    if(od.active) active.push(od.display);
  });
  if(active.length === 0) list.innerHTML = '<div class="muted small">Nadie en servicio</div>';
  else active.forEach(a => { const el = document.createElement('div'); el.className='item'; el.textContent = a; list.appendChild(el); });
  updateHeader();
}

/* ========== INCAUTACIONES (vehículos) ========== */
function renderIncautaciones(){
  STATE.expanded = 'incautaciones';
  expandedRoot.innerHTML = `<div class="expanded">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Incautaciones</strong><div class="muted">Registrar vehículos incautados</div></div>
      <div><button class="btn" id="closeI">Cerrar</button></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:12px">
      <div style="flex:1">
        <input id="vehPlate" placeholder="Matrícula"/>
        <input id="vehModel" placeholder="Modelo"/>
        <textarea id="vehReason" placeholder="Motivo de incautación"></textarea>
        <div style="display:flex;gap:8px"><button id="vehSave" class="btn">Registrar incautación</button></div>
      </div>
      <div style="width:320px">
        <div class="muted small">Vehículos incautados</div>
        <div id="vehList" class="list"></div>
      </div>
    </div>
  </div>`;
  document.getElementById('closeI').onclick = ()=> closeExpanded();
  document.getElementById('vehSave').onclick = saveVeh;
  loadVeh();
}
async function saveVeh(){
  if(!STATE.currentUser){ showAviso('Login requerido'); return; }
  const plate = document.getElementById('vehPlate').value.trim();
  const model = document.getElementById('vehModel').value.trim();
  const reason = document.getElementById('vehReason').value.trim();
  if(!plate || !reason){ alert('Matrícula y motivo requeridos'); return; }
  await addDoc(collection(db,'incautaciones'), { plate, model, reason, author: STATE.currentUser.display, created_at: serverTimestamp() });
  await pushAudit(`Vehículo incautado: ${plate}`);
  showAviso('Incautación registrada');
  loadVeh();
}
async function loadVeh(){
  const snap = await getDocs(collection(db,'incautaciones'));
  const list = document.getElementById('vehList'); list.innerHTML = '';
  if(snap.empty) { list.innerHTML = '<div class="muted small">Sin incautaciones</div>'; return; }
  snap.forEach(d=>{
    const v = d.data();
    const it = document.createElement('div'); it.className = 'item';
    it.innerHTML = `<div style="flex:1"><b>${v.plate} ${v.model||''}</b><div class="muted small">${v.reason}</div></div><div>${v.author||''}</div>`;
    list.appendChild(it);
  });
}

/* ========== ALERTAS ciudad (verde/amarilla/roja) ========== */
function renderAlertas(){
  STATE.expanded = 'alertas';
  expandedRoot.innerHTML = `<div class="expanded">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Alertas ciudad</strong><div class="muted">Crear y listar alertas (verde/amarilla/roja)</div></div>
      <div><button class="btn" id="closeA2">Cerrar</button></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:12px">
      <div style="flex:1">
        <select id="alertLevel"><option value="verde">Verde</option><option value="amarilla">Amarilla</option><option value="roja">Roja</option></select>
        <input id="alertTitle" placeholder="Título de la alerta"/>
        <textarea id="alertDesc" placeholder="Descripción..."></textarea>
        <div style="display:flex;gap:8px"><button id="alertCreate" class="btn">Crear alerta</button></div>
      </div>
      <div style="width:320px">
        <div class="muted small">Alertas activas</div>
        <div id="alertList" class="list"></div>
      </div>
    </div>
  </div>`;
  document.getElementById('closeA2').onclick = ()=> closeExpanded();
  document.getElementById('alertCreate').onclick = createAlert;
  loadAlerts();
}
async function createAlert(){
  if(!STATE.currentUser){ showAviso('Login requerido'); return; }
  const level = document.getElementById('alertLevel').value;
  const title = document.getElementById('alertTitle').value.trim();
  const desc = document.getElementById('alertDesc').value.trim();
  if(!title || !desc) { alert('Título y descripción requeridos'); return; }
  await addDoc(collection(db,'alertas'), { level, title, description: desc, author: STATE.currentUser.display, created_at: serverTimestamp() });
  await pushAudit(`Alerta creada: [${level}] ${title}`);
  showAviso(`Alerta ${level}: ${title}`,7000);
  loadAlerts();
}
async function loadAlerts(){
  const snap = await getDocs(collection(db,'alertas'));
  const list = document.getElementById('alertList'); list.innerHTML = '';
  if(snap.empty){ list.innerHTML = '<div class="muted small">Sin alertas</div>'; return; }
  snap.forEach(d=>{
    const a = d.data();
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div style="flex:1"><b>[${a.level}] ${a.title}</b><div class="muted small">${a.description}</div></div><div>${a.author||''}</div>`;
    list.appendChild(it);
  });
}

/* ========== ADMIN (roles & users) ========== */
async function renderAdmin(){
  STATE.expanded = 'admin';
  // load roles for select
  const rolesSnap = await getDocs(collection(db,'roles'));
  const rolesArr = [];
  rolesSnap.forEach(d=> rolesArr.push({id:d.id, ...d.data()}));
  expandedRoot.innerHTML = `<div class="expanded">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Administración</strong><div class="muted">Gestión usuarios y roles</div></div>
      <div><button class="btn" id="closeAdm">Cerrar</button></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:12px">
      <div style="flex:1">
        <h4>Usuarios</h4>
        <div id="usersAdmin" class="list"></div>
      </div>
      <div style="width:360px">
        <h4>Crear usuario (solo admin)</h4>
        <input id="adm_user" placeholder="username"><input id="adm_display" placeholder="display"><input id="adm_pass" placeholder="password">
        <select id="adm_role">${rolesArr.map(r=>`<option value="${r.id}">${r.id}</option>`).join('')}</select>
        <div style="display:flex;gap:8px;margin-top:8px"><button id="adm_create" class="btn">Crear usuario</button><button id="adm_refresh" class="btn-ghost">Refrescar</button></div>
        <hr style="margin:12px 0;border-top:1px solid #22303f">
        <h4>Roles</h4>
        <input id="adm_role_new" placeholder="Nombre rol"><button id="adm_role_create" class="btn" style="margin-top:6px">Crear rol</button>
        <div id="rolesAdminList" style="margin-top:12px"></div>
      </div>
    </div>
  </div>`;
  document.getElementById('closeAdm').onclick = ()=> closeExpanded();
  document.getElementById('adm_create').onclick = adminCreateUser;
  document.getElementById('adm_refresh').onclick = renderAdmin;
  document.getElementById('adm_role_create').onclick = adminCreateRole;
  loadUsersAdmin();
  loadRolesAdmin();
}
async function loadUsersAdmin(){
  const snap = await getDocs(collection(db,'users'));
  const list = document.getElementById('usersAdmin'); list.innerHTML = '';
  if(snap.empty){ list.innerHTML = '<div class="muted small">Sin usuarios</div>'; return; }
  snap.forEach(d=>{
    const u = d.data();
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div><b>${u.display} (${u.username})</b><div class="muted small">Rol: ${u.role || '—'}</div></div>
      <div style="text-align:right">
        <select data-uid="${d.id}" class="roleSel">${/* roles loaded later */''}</select>
        <div style="margin-top:6px"><button class="btn-ghost" data-uid="${d.id}" data-act="del">Borrar</button>
        <button class="btn" data-uid="${d.id}" data-act="imp">Impersonar</button></div></div>`;
    list.appendChild(it);
  });
  // fill role selects
  const rolesSnap = await getDocs(collection(db,'roles'));
  const rolesArr = [];
  rolesSnap.forEach(r=> rolesArr.push(r.id));
  list.querySelectorAll('.roleSel').forEach(sel=>{
    const uid = sel.dataset.uid;
    sel.innerHTML = rolesArr.map(r=>`<option value="${r}">${r}</option>`).join('');
    // set selected value
    getDoc(doc(db,'users',uid)).then(snap=>{ if(snap.exists()){ const data=snap.data(); sel.value = data.role || ''; } });
    sel.onchange = async (e)=>{
      const newRole = e.target.value;
      const uid2 = e.target.dataset.uid;
      await updateDoc(doc(db,'users', uid2), { role: newRole });
      await pushAudit(`Cambio rol: ${uid2} -> ${newRole}`);
      showAviso('Rol actualizado');
      loadUsersAdmin();
    };
  });
  // attach delete & impersonate
  list.querySelectorAll('button[data-act="del"]').forEach(b=> b.onclick = async ()=>{
    const uid = b.dataset.uid;
    if(!confirm('Borrar usuario?')) return;
    const docSnap = await getDoc(doc(db,'users', uid));
    if(docSnap.exists() && docSnap.data().username === 'admin'){ alert('No puedes borrar la cuenta admin base'); return; }
    await deleteDoc(doc(db,'users', uid));
    await pushAudit(`Usuario borrado: ${uid}`);
    loadUsersAdmin();
  });
  list.querySelectorAll('button[data-act="imp"]').forEach(b=> b.onclick = async ()=>{
    const uid = b.dataset.uid;
    const snap = await getDoc(doc(db,'users',uid));
    if(!snap.exists()) return;
    const target = { id: snap.id, ...snap.data() };
    // impersonation: keep the original admin in STATE.impersonator to revert later
    STATE.impersonator = STATE.currentUser;
    // set currentUser to target but keep admin privileges if impersonator was admin
    if(STATE.impersonator && STATE.impersonator.role === 'admin'){
      // set a marker to indicate adminOverride
      target.adminOverride = true;
      target._impersonated_by = STATE.impersonator.id;
    }
    STATE.currentUser = target;
    updateHeader();
    await pushAudit(`Impersonación: ${STATE.impersonator?.display || 'Sistema'} -> ${target.username}`);
    showAviso(`Impersonando: ${target.display}`);
    // refresh admin view so that admin still sees everything
    loadUsersAdmin();
  });
}
async function adminCreateUser(){
  if(!STATE.currentUser || STATE.currentUser.role !== 'admin'){ alert('Solo admin puede crear usuarios'); return; }
  const username = document.getElementById('adm_user').value.trim();
  const display = document.getElementById('adm_display').value.trim() || username;
  const pass = document.getElementById('adm_pass').value.trim() || 'changeme';
  const role = document.getElementById('adm_role').value;
  if(!username){ alert('username requerido'); return; }
  // check exists
  const snap = await getDocs(collection(db,'users'));
  let exists = false;
  snap.forEach(d => { if(d.data().username === username) exists = true; });
  if(exists){ alert('Usuario ya existe'); return; }
  await addDoc(collection(db,'users'), { username, display, password: pass, role });
  await pushAudit(`Usuario creado por admin: ${username}`);
  showAviso('Usuario creado');
  loadUsersAdmin();
}
async function adminCreateRole(){
  if(!STATE.currentUser || STATE.currentUser.role !== 'admin'){ alert('Solo admin'); return; }
  const name = document.getElementById('adm_role_new').value.trim();
  if(!name){ alert('Nombre rol requerido'); return; }
  // create role doc
  await setDoc(doc(db,'roles',name), { name, permissions: [] });
  await pushAudit(`Rol creado: ${name}`);
  showAviso('Rol creado');
  loadRolesAdmin();
}
async function loadRolesAdmin(){
  const snap = await getDocs(collection(db,'roles'));
  const out = document.getElementById('rolesAdminList'); out.innerHTML = '';
  snap.forEach(d=>{
    const rd = d.data();
    const div = document.createElement('div'); div.className = 'item';
    div.innerHTML = `<div style="flex:1"><b>${d.id}</b><div class="muted small">Permisos: ${(rd.permissions||[]).join(', ') || '—'}</div></div>
      <div><button class="btn-ghost" data-role="${d.id}" data-act="edit">Editar</button> <button class="btn" data-role="${d.id}" data-act="del">Borrar</button></div>`;
    out.appendChild(div);
  });
  out.querySelectorAll('button[data-act="edit"]').forEach(b=> b.onclick = ()=> openRoleEditor(b.dataset.role));
  out.querySelectorAll('button[data-act="del"]').forEach(b=> b.onclick = async ()=>{
    if(!confirm('Borrar rol?')) return;
    await deleteDoc(doc(db,'roles', b.dataset.role));
    // remove role from users who had it
    const usersSnap = await getDocs(collection(db,'users'));
    usersSnap.forEach(async uDoc=>{
      const u = uDoc.data();
      if(u.role === b.dataset.role) await updateDoc(doc(db,'users', uDoc.id), { role: '' });
    });
    await pushAudit(`Rol borrado: ${b.dataset.role}`);
    loadRolesAdmin();
  });
}
function openRoleEditor(roleKey){
  // build modal DOM in page
  const overlay = document.createElement('div'); overlay.className = 'overlay';
  overlay.innerHTML = `<div class="modal"><h3>Editar rol: ${roleKey}</h3><div class="muted small">Marca permisos</div><div id="permBox"></div>
    <div style="display:flex;gap:8px;margin-top:12px"><button id="saveRoleBtn" class="btn">Guardar</button><button id="cancelRoleBtn" class="btn-ghost">Cancelar</button></div></div>`;
  document.body.appendChild(overlay);
  const perms = ['create_reports','delete_reports','create_pda','create_call','assign_call','create_bolo','manage_wanted','create_fine','export','all'];
  const box = overlay.querySelector('#permBox');
  // load current
  getDoc(doc(db,'roles',roleKey)).then(snap=> {
    const role = snap.data() || { permissions: []};
    box.innerHTML = perms.map(p=>`<div style="margin-bottom:6px"><label><input type="checkbox" data-perm="${p}" ${role.permissions && role.permissions.includes(p)?'checked':''}/> ${p}</label></div>`).join('');
  });
  overlay.querySelector('#cancelRoleBtn').onclick = ()=> overlay.remove();
  overlay.querySelector('#saveRoleBtn').onclick = async ()=>{
    const checked = Array.from(box.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.dataset.perm);
    await setDoc(doc(db,'roles', roleKey), { name: roleKey, permissions: checked });
    await pushAudit(`Rol editado: ${roleKey}`);
    overlay.remove(); loadRolesAdmin();
  };
}

/* ========== AUDIT view (admin/sargento) ========== */
async function renderAudit(){
  STATE.expanded = 'audit';
  expandedRoot.innerHTML = `<div class="expanded">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Auditoría</strong><div class="muted">Últimas acciones</div></div>
      <div><button class="btn" id="closeAudit">Cerrar</button></div>
    </div>
    <div style="margin-top:12px"><div id="auditList" class="list"></div></div>
  </div>`;
  document.getElementById('closeAudit').onclick = ()=> closeExpanded();
  loadAudit();
}
async function loadAudit(){
  const snap = await getDocs(collection(db,'audit'));
  const list = document.getElementById('auditList'); list.innerHTML = '';
  if(snap.empty) { list.innerHTML = '<div class="muted small">Sin registros</div>'; return; }
  snap.forEach(d=>{
    const a = d.data();
    const it = document.createElement('div'); it.className = 'item';
    it.innerHTML = `<div style="flex:1"><b>${a.action}</b><div class="muted small">${a.actor} • ${a.ts ? (a.ts.toDate ? a.ts.toDate().toLocaleString() : a.ts) : ''}</div></div>`;
    list.appendChild(it);
  });
}

/* ========== Misc helpers ========== */
function closeExpanded(){ STATE.expanded = null; expandedRoot.innerHTML = ''; }
function initUI(){
  renderCards();
  // setup realtime listeners on load to refresh views globally
  setupRealtime();
  // initial header
  updateHeader();
}
/* call init */
initUI();

/* ========== Export/Import (admin) ========== */
async function exportAllData(){
  if(!STATE.currentUser) { alert('Login requerido'); return; }
  if(STATE.currentUser.role !== 'admin'){ alert('Solo admin puede exportar'); return; }
  // fetch all collections used
  const colNames = ['users','roles','pda','reports','calls','wanted','fines','incautaciones','alertas','audit','onDuty'];
  const out = {};
  for(const c of colNames){
    const snap = await getDocs(collection(db,c));
    out[c] = [];
    snap.forEach(d=> out[c].push({ id: d.id, ...d.data() }));
  }
  const blob = new Blob([JSON.stringify(out,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `wizardrp_export_${Date.now()}.json`; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  showAviso('Exportado JSON (descarga)');
}
async function importAllData(file){
  if(!STATE.currentUser || STATE.currentUser.role !== 'admin'){ alert('Solo admin puede importar'); return; }
  const text = await file.text();
  const data = JSON.parse(text);
  // This is destructive — remove existing docs (simple approach)
  if(!confirm('Importar reemplazará colecciones locales en Firestore. Continuar?')) return;
  for(const colName in data){
    // naive: add each item as new doc with same id (setDoc)
    const arr = data[colName];
    for(const item of arr){
      const id = item.id;
      const payload = {...item}; delete payload.id;
      await setDoc(doc(db, colName, id), payload);
    }
  }
  showAviso('Importación completada');
  await pushAudit('Importación masiva realizada por admin');
}

/* ========== Final notes: remove just_changed flags periodically ========== */
// small cleanup: when onDuty or calls updated with markers we set, we clear markers after a short delay
// We'll implement when writing to docs we set flags; later we could remove them via scheduled cleanup if needed.

</script>
</body>
</html>
<!-- --------------- FIN PARTE 2 --------------- -->
