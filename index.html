<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Daynight RP — PDA Policial (Online)</title>
<style>
  :root{
    --bg:#071018; --muted:#98a8b0; --accent:#844ffc; --accent2:#6ee7b7;
    --card:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    --glass: rgba(255,255,255,0.03);
    --radius:12px;
    --danger:#ff6b6b;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:
      radial-gradient(900px 350px at 10% 10%, rgba(132,79,252,0.04), transparent),
      linear-gradient(180deg, #03121a 0%, var(--bg) 60%);
    color:#e7eef6; -webkit-font-smoothing:antialiased;
  }
  .wrap{max-width:1200px;margin:18px auto;padding:18px;display:grid;grid-template-rows:auto 1fr;gap:14px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo-img{width:72px;height:72px;border-radius:12px;background:#fff;padding:6px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .logo-img img{width:100%;height:100%;object-fit:contain}
  h1{margin:0;font-size:20px}
  .subtitle{color:var(--muted);font-size:13px}
  .top-right{display:flex;gap:8px;align-items:center}
  .pill{background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:999px;font-weight:700}
  .small{font-size:12px;color:var(--muted)}
  .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:7px 10px;border-radius:10px;cursor:pointer}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  .card{background:var(--card);border-radius:var(--radius);padding:18px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(2,6,10,0.6);cursor:pointer;overflow:hidden;position:relative;display:flex;flex-direction:column;gap:12px;min-height:120px;transition:transform .22s,box-shadow .22s}
  .card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,6,10,0.75)}
  .title{font-weight:900;font-size:16px}
  .desc{color:var(--muted);font-size:13px}
  .icon{width:56px;height:56px;border-radius:10px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;font-size:22px}
  .expanded{margin-top:14px;border-radius:var(--radius);padding:18px;background:var(--card);border:1px solid rgba(255,255,255,0.03)}
  .form-row{display:flex;gap:8px}
  input,textarea,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  textarea{min-height:110px;resize:vertical}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{padding:10px;border-radius:10px;background:var(--glass);display:flex;justify-content:space-between;align-items:center}
  .muted{color:var(--muted)}
  .danger{background:linear-gradient(90deg,#ff8a80,#ff5252);color:#041018;padding:6px 8px;border-radius:8px}
  .ok{background:linear-gradient(90deg,#48c774,#34d399);color:#041018;padding:6px 8px;border-radius:8px}
  .tiny{font-size:12px}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  .overlay{position:fixed;inset:0;background:linear-gradient(rgba(2,6,10,0.6),rgba(2,6,10,0.8));display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{width:720px;max-width:94%;background:linear-gradient(180deg,#071729,#061421);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .link-like{color:var(--accent);cursor:pointer;text-decoration:underline}
  .grid-2{display:grid;grid-template-columns:1fr 360px;gap:12px}
  .role-chip{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);margin-right:6px;margin-bottom:6px}
  .toast{position:fixed;right:18px;bottom:18px;background:rgba(0,0,0,0.7);color:#fff;padding:12px 14px;border-radius:10px;z-index:20000;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
  .hidden{display:none}
  @media (max-width:980px){ .grid{grid-template-columns:repeat(2,1fr)} .grid-2{grid-template-columns:1fr} }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} .form-row{flex-direction:column} .modal{width:94%} }
  .btn-small{padding:6px 8px;font-size:13px;border-radius:8px}
  .pill-count{background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:8px}
  .img-thumb{width:64px;height:64px;border-radius:8px;object-fit:cover}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo-img"><img id="logoImg" src="https://cdn.discordapp.com/attachments/1421898595271180360/1422217488145453219/LOGO_WIZARD_FONDO.png.png" alt="Logo" /></div>
        <div>
          <h1>Daynight RP — PDA / CAD</h1>
          <div class="subtitle">Sistema online — sincronizado en tiempo real</div>
        </div>
      </div>

      <div class="top-right">
        <div class="pill small" id="userDisplay">No conectado</div>
        <div class="pill small" id="dutyStatus">En servicio: 0</div>
        <button id="btnExport" class="btn">Exportar</button>
        <button id="btnLogin" class="btn-ghost">Iniciar</button>
      </div>
    </header>

    <section class="grid" id="cardsRoot"></section>

    <div id="expandedRoot"></div>

    <footer>Hecho para Daynight RP • Online con Firebase • Guarda tus datos con seguridad</footer>
  </div>

  <!-- Login modal (mantengo la interfaz que pediste pero registro solo por admin) -->
  <div id="loginModal" class="overlay hidden">
    <div class="modal">
      <h3>Entrar</h3>
      <div class="muted small">Accede con tu cuenta (creada por administradores).</div>
      <div style="margin-top:12px">
        <label class="muted small">Usuario</label>
        <input id="loginUser" placeholder="usuario (ej: admin)"/>
        <label class="muted small" style="margin-top:8px">Contraseña</label>
        <input id="loginPass" type="password" placeholder="contraseña"/>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="loginBtn" class="btn">Entrar</button>
          <button id="guestBtn" class="btn-ghost">Invitado</button>
          <div style="margin-left:auto" class="small muted">¿Necesitas cuenta? Contacta con un admin</div>
        </div>
        <div id="loginError" class="muted small" style="margin-top:8px;color:#ff9b9b;display:none"></div>
      </div>
    </div>
  </div>

  <div id="toastRoot" style="position:fixed;right:18px;bottom:18px;z-index:20000"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <!-- NOTE: We're using compat libs for simpler code in a single file. -->

<script>
/* ======================================================
   Daynight RP — index.html (single file)
   - Usa Firestore + Storage (Firebase) en tiempo real
   - Copia/pega todo en index.html
   ====================================================== */

/* ------------------- CONFIGURACIÓN FIREBASE -------------------
   He usado las credenciales que me proporcionaste para que funcione
   directamente. Si prefieres no exponerlas, reemplaza estos valores.
-----------------------------------------------------------------*/
const firebaseConfig = {
  apiKey: "AIzaSyCskczYgGtlPPBEIZiE5PuY7s_cfE_3Chg",
  authDomain: "wizard-rp.firebaseapp.com",
  projectId: "wizard-rp",
  storageBucket: "wizard-rp.firebasestorage.app",
  messagingSenderId: "479456044047",
  appId: "1:479456044047:web:65c52e2430bcb6ca586f7a",
  measurementId: "G-KX5Y56CG0R"
};

/* ------------------- Inicializar Firebase ------------------- */
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

/* ------------------- Estado de la App ------------------- */
let STATE = {
  currentUser: null,      // objeto user actual (desde Firestore)
  impersonatorId: null,   // si admin está impersonando mantiene su id aquí
  expanded: null
};

/* ------------------- Helpers UI ------------------- */
const cardsRoot = document.getElementById('cardsRoot');
const expandedRoot = document.getElementById('expandedRoot');
const userDisplay = document.getElementById('userDisplay');
const dutyStatus = document.getElementById('dutyStatus');
const loginModal = document.getElementById('loginModal');
const btnLogin = document.getElementById('btnLogin');
const btnExport = document.getElementById('btnExport');
const toastRoot = document.getElementById('toastRoot');

function showToast(msg, timeout=4500){
  const t = document.createElement('div'); t.className='toast'; t.textContent = msg;
  toastRoot.appendChild(t);
  setTimeout(()=>{ t.style.transition='opacity .4s'; t.style.opacity=0; setTimeout(()=>t.remove(),400); }, timeout);
}

function showModal(html){
  const overlay = document.createElement('div'); overlay.className='overlay';
  overlay.innerHTML = `<div class="modal">${html}</div>`;
  overlay.onclick = (e)=>{ if(e.target===overlay) overlay.remove(); };
  document.body.appendChild(overlay);
  return overlay;
}

/* ------------------- Utilidades Firestore ------------------- */
function docId(){ return Math.random().toString(36).slice(2,9); }
function now(){ return Date.now(); }

/* Push log into Firestore (only for admin/sergeant or users created by them) */
async function pushLog(msg){
  try{
    const u = STATE.currentUser;
    // Only create audit logs if the acting user qualifies:
    // either role === admin|sergeant OR their createdByRole === admin|sergeant
    if(!u) return;
    const qualifies = (u.role === 'admin' || u.role === 'sergeant' || (u.createdByRole && (u.createdByRole==='admin' || u.createdByRole==='sergeant')));
    if(!qualifies) return;
    await db.collection('logs').add({ msg, t: firebase.firestore.FieldValue.serverTimestamp(), actor: u.username, actorId: u.id });
    // UI update will come from realtime listener on logs
  }catch(e){ console.error('pushLog err', e); }
}

/* ------------------- Seed inicial (si la colección users está vacía) ------------------- */
async function seedIfNeeded(){
  const snap = await db.collection('meta').doc('init').get().catch(()=>null);
  if(snap && snap.exists && snap.data && snap.data().done) return;
  // Check users collection
  const uSnap = await db.collection('users').limit(1).get();
  if(uSnap.empty){
    // crear admin por defecto
    const adminId = 'u_admin';
    await db.collection('users').doc(adminId).set({
      id: adminId,
      username: 'admin',
      display: 'Admin',
      badge: 'ADM-001',
      password: 'DayNightRP@2025',
      role: 'admin',
      createdBy: 'system',
      createdByRole: 'admin',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    // ejemplo de datos
    await db.collection('reports').add({ title: 'Robo tienda', description: 'Robo con arma blanca. Sospechoso huye.', author: 'Admin', authorId: adminId, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    await db.collection('calls').add({ caller: 'Civ. Morales', message: 'Disparo en puerto', status: 'pending', assigned_to: null, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    await db.collection('wanted').add({ name: 'Mario Rata', description: 'Robo coches', bounty: 500, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    await db.collection('pda').add({ title:'Ficha: Juan Pérez', text:'Nombre: Juan Pérez\\nAlias: rata\\nDelitos: robo', author: 'Admin', authorId: adminId, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    await db.collection('fines').add({ offender:'Veh LSF-021', amount:200, reason:'Exceso velocidad', author:'Admin', authorId: adminId, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    await db.collection('roles').doc('defaultRoles').set({
      officer: { name: 'Officer', color:'#7c3aed', permissions: ['create_reports','create_pda','create_call'] },
      sergeant: { name: 'Sergeant', color:'#3b82f6', permissions: ['create_reports','delete_reports','create_pda','create_call'] },
      dispatcher: { name: 'Dispatcher', color:'#f97316', permissions: ['create_call','assign_call'] },
      admin: { name:'Admin', color:'#10b981', permissions: ['all'] }
    });
    await db.collection('meta').doc('init').set({ done:true });
    console.log('Seed inicial creada.');
  }
}

/* ------------------- Realtime listeners ------------------- */
let unsubscribes = [];
function startRealtime(){
  // calls
  unsubscribes.push(db.collection('calls').orderBy('createdAt','desc').onSnapshot(loadCallsRealtime));
  // pda
  unsubscribes.push(db.collection('pda').orderBy('createdAt','desc').onSnapshot(loadPDARealtime));
  // reports
  unsubscribes.push(db.collection('reports').orderBy('createdAt','desc').onSnapshot(loadReportsRealtime));
  // wanted
  unsubscribes.push(db.collection('wanted').orderBy('createdAt','desc').onSnapshot(loadWantedRealtime));
  // fines
  unsubscribes.push(db.collection('fines').orderBy('createdAt','desc').onSnapshot(loadFinesRealtime));
  // users
  unsubscribes.push(db.collection('users').orderBy('display').onSnapshot(loadUsersRealtime));
  // logs (admin panel)
  unsubscribes.push(db.collection('logs').orderBy('t','desc').limit(200).onSnapshot(snap=>{ window.latestLogs = snap.docs.map(d=>({id:d.id,...d.data()})); }));
  // onDuty
  unsubscribes.push(db.collection('onDuty').onSnapshot(loadDutyRealtime));
}

/* ------------------- Render principales cards ------------------- */
const CARDS = [
  {id:'pda', title:'PDA / Fichas', desc:'Buscar y crear fichas PDA', icon:'🚓'},
  {id:'calls', title:'Dispatch / Llamadas', desc:'Crear/Asignar llamadas', icon:'📞'},
  {id:'reports', title:'Informes', desc:'Crear / Editar informes', icon:'📑'},
  {id:'wanted', title:'BOLO / Wanted', desc:'Fichas buscados', icon:'🚨'},
  {id:'fines', title:'Multas', desc:'Generar sanciones', icon:'💸'},
  {id:'service', title:'Servicio', desc:'Entrar / Salir de servicio', icon:'🟢'},
  {id:'admin', title:'Administración', desc:'Roles y usuarios (admin)', icon:'⚙️'},
  {id:'logs', title:'Auditoría', desc:'Historial de acciones', icon:'📜'},
  {id:'tools', title:'Incautaciones / Alertas', desc:'Alertas ciudadanas y registros', icon:'🧰'}
];

function renderCards(){
  cardsRoot.innerHTML = '';
  CARDS.forEach(c=>{
    const el = document.createElement('div'); el.className='card'; el.dataset.id=c.id;
    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><div class="title">${c.title}</div><div class="desc">${c.desc}</div></div>
      <div class="icon">${c.icon}</div>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="muted tiny">Acción rápida</div>
      <div><button class="btn-ghost" data-open="${c.id}">Abrir</button></div>
    </div>`;
    el.onclick = ()=>openCard(c.id);
    el.querySelector('button[data-open]').onclick = (e)=>{ e.stopPropagation(); openCard(c.id); };
    cardsRoot.appendChild(el);
  });
}

/* ------------------- Abrir panel ------------------- */
function openCard(id){
  STATE.expanded = id;
  expandedRoot.innerHTML = '';
  const panel = document.createElement('div'); panel.className='expanded';
  if(id==='pda') renderPDA(panel);
  else if(id==='calls') renderCalls(panel);
  else if(id==='reports') renderReports(panel);
  else if(id==='wanted') renderWanted(panel);
  else if(id==='fines') renderFines(panel);
  else if(id==='service') renderService(panel);
  else if(id==='admin') renderAdmin(panel);
  else if(id==='logs') renderLogs(panel);
  else if(id==='tools') renderTools(panel);
  expandedRoot.appendChild(panel);
  window.scrollTo({ top: panel.offsetTop-20, behavior:'smooth' });
}

/* ========================= PDA ========================= */
function renderPDA(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>PDA / Fichas</strong><div class="muted small">Buscar y crear fichas (adjuntar imagen opcional)</div></div>
    <div><button class="btn btn-small" id="closeP">Cerrar</button></div>
  </div>
  <div style="margin-top:12px" class="grid-2">
    <div>
      <div class="muted small">Buscar</div>
      <input id="pdaQ" placeholder="Buscar por nombre, alias o texto..." />
      <div id="pdaResults" style="margin-top:12px"></div>
    </div>
    <div>
      <div class="muted small">Crear nueva ficha (plantilla editable)</div>
      <textarea id="pdaTpl">Nombre: \nAlias: \nNotas: </textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="pdaImage" type="file" accept="image/*" style="width:auto"/>
        <button id="createPDA" class="btn">Crear ficha</button>
        <button id="clearPDA" class="btn-ghost">Limpiar</button>
      </div>
    </div>
  </div>`;
  container.querySelector('#closeP').onclick = ()=> closeExpanded();
  container.querySelector('#pdaQ').oninput = ()=> searchPDA(document.getElementById('pdaQ').value);
  container.querySelector('#createPDA').onclick = createPDA;
  loadPDARealtimeSnapshotOnce();
}

async function loadPDARealtimeSnapshotOnce(){
  const resDiv = document.getElementById('pdaResults');
  if(!resDiv) return;
  // initial load will be handled by realtime listener loadPDARealtime
  resDiv.innerHTML = '<div class="muted small">Cargando fichas...</div>';
}
function loadPDARealtime(snapshot){
  // snapshot may be array if called as listener
  let docs = [];
  if(snapshot && snapshot.forEach){ snapshot.forEach(d=>docs.push({id:d.id,...d.data()})); }
  else {
    // if called manually, fetch
    db.collection('pda').orderBy('createdAt','desc').get().then(s=>{ loadPDARealtime(s); });
    return;
  }
  const res = document.getElementById('pdaResults');
  if(!res) return;
  res.innerHTML = docs.map(p=>`<div class="item"><div style="flex:1"><b>${p.title||'Ficha'}</b><div class="muted small">${(p.text||'').slice(0,140)}</div></div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
      ${p.imageUrl?`<img class="img-thumb" src="${p.imageUrl}" />`:''}
      <div><button class="btn-ghost btn-small" onclick="viewPDA('${p.id}')">Abrir</button> <button class="btn-ghost btn-small" onclick="tryDeletePDA('${p.id}')">Borrar</button></div>
    </div></div>`).join('') || '<div class="muted small">Sin fichas</div>';
}

async function createPDA(){
  if(!STATE.currentUser){ showToast('Debes iniciar sesión para crear fichas'); return; }
  // permisos
  if(!(STATE.currentUser.role === 'admin' || STATE.currentUser.role === 'sergeant' || STATE.currentUser.role === 'officer' )){ showToast('No tienes permiso para crear fichas'); return; }
  const text = document.getElementById('pdaTpl').value.trim();
  if(!text){ showToast('Rellena la plantilla'); return; }
  const fileInput = document.getElementById('pdaImage');
  let imageUrl = null;
  try{
    if(fileInput && fileInput.files && fileInput.files[0]){
      const f = fileInput.files[0];
      const storageRef = storage.ref().child(`pda_images/${Date.now()}_${f.name}`);
      const snap = await storageRef.put(f);
      imageUrl = await snap.ref.getDownloadURL();
    }
    const title = text.split('\n')[0].replace('Nombre:','').trim() || 'Ficha';
    await db.collection('pda').add({ title, text, imageUrl, author: STATE.currentUser.display, authorId: STATE.currentUser.id, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    showToast('Ficha PDA creada');
    pushLog(`PDA creada: ${title}`);
    document.getElementById('pdaTpl').value = '';
    if(fileInput) fileInput.value = '';
  }catch(e){ console.error(e); showToast('Error al subir imagen o guardar'); }
}

/* Deletion rules: only admin OR author OR sergeant can delete */
async function tryDeletePDA(id){
  const doc = await db.collection('pda').doc(id).get();
  const data = doc.data();
  if(!STATE.currentUser){ showToast('Inicia sesión'); return; }
  const isAuthor = data && data.authorId === STATE.currentUser.id;
  const allowed = (STATE.currentUser.role === 'admin' || STATE.currentUser.role === 'sergeant' || isAuthor);
  if(!allowed){ showToast('No puedes borrar esta ficha'); return; }
  if(!confirm('Borrar ficha PDA?')) return;
  await db.collection('pda').doc(id).delete();
  showToast('Ficha borrada');
  pushLog(`PDA ${id} borrada`);
}

async function viewPDA(id){
  const doc = await db.collection('pda').doc(id).get();
  const data = doc.data();
  if(!data) return;
  let html = `<h3>${data.title}</h3><pre style="white-space:pre-wrap">${data.text}</pre>`;
  if(data.imageUrl) html += `<div style="margin-top:8px"><img src="${data.imageUrl}" style="max-width:100%;border-radius:8px"/></div>`;
  if(data.author) html += `<div class="muted small" style="margin-top:8px">Autor: ${data.author}</div>`;
  showModal(html);
}

/* ========================= CALLS (Dispatch) ========================= */
function renderCalls(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Dispatch / Llamadas</strong><div class="muted small">Crear llamadas y asignar unidades</div></div>
    <div><button class="btn btn-small" id="closeC">Cerrar</button></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:8px">
    <input id="callFrom" placeholder="Remitente (opcional)"/>
    <input id="callMsg" placeholder="Mensaje"/>
    <button id="callCreate" class="btn">Crear llamada</button>
  </div>
  <div style="margin-top:12px"><strong>Llamadas</strong><div id="callsList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeC').onclick = ()=> closeExpanded();
  container.querySelector('#callCreate').onclick = createCall;
  // initial load handled by realtime listener
}

async function createCall(){
  const caller = document.getElementById('callFrom').value.trim() || 'Anonimo';
  const message = document.getElementById('callMsg').value.trim();
  if(!message){ showToast('Introduce un mensaje'); return; }
  try{
    const docRef = await db.collection('calls').add({ caller, message, status:'pending', assigned_to:null, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    document.getElementById('callMsg').value=''; document.getElementById('callFrom').value='';
    showToast('Llamada creada');
    pushLog(`Llamada creada por ${caller}`);
    // notify all listening clients via listener -> show toast in their UI
  }catch(e){ console.error(e); showToast('Error creando llamada'); }
}

function loadCallsRealtime(snapshot){
  let docs = [];
  snapshot.forEach(d=>docs.push({id:d.id,...d.data()}));
  const list = document.getElementById('callsList');
  if(!list) return;
  list.innerHTML = '';
  if(!docs.length){ list.innerHTML = '<div class="muted small">No hay llamadas</div>'; return; }
  const users = window.latestUsers || [];
  docs.forEach(c=>{
    const assigneeName = c.assigned_to ? (users.find(u=>u.id===c.assigned_to)?.display || '—') : '—';
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${c.caller}</div><div class="muted small">${c.message}</div></div>
      <div style="text-align:right"><div class="muted tiny">${c.createdAt && c.createdAt.toDate ? c.createdAt.toDate().toLocaleString() : ''}</div><div style="margin-top:8px" class="muted tiny">Asig: ${assigneeName}</div></div>`;
    const btns = document.createElement('div'); btns.style.marginLeft='12px';
    // assign dropdown of onDuty users
    const assignBtn = document.createElement('button'); assignBtn.className='btn-ghost btn-small'; assignBtn.textContent='Asignar';
    assignBtn.onclick = async ()=>{
      // fetch active onDuty users to allow assignment
      const on = await db.collection('onDuty').where('active','==',true).get();
      const options = on.docs.map(d=>d.data());
      if(!options.length){ alert('No hay unidades en servicio'); return; }
      // build HTML for selection
      const selHtml = `<div><h4>Asignar llamada</h4><div class="muted small">Selecciona unidad en servicio</div>
        <div style="margin-top:8px">${options.map(o=>`<div style="margin-bottom:6px"><label><input type="radio" name="assign_${c.id}" value="${o.userId}"/> ${o.display}</label></div>`).join('')}</div>
        <div style="display:flex;gap:8px;margin-top:12px"><button id="doAssign" class="btn">Asignar</button> <button id="cancelAssign" class="btn-ghost">Cancelar</button></div></div>`;
      const ov = showModal(selHtml);
      ov.querySelector('#cancelAssign').onclick = ()=> ov.remove();
      ov.querySelector('#doAssign').onclick = async ()=>{
        const sel = ov.querySelector(`input[name="assign_${c.id}"]:checked`);
        if(!sel){ alert('Selecciona una unidad'); return; }
        const userId = sel.value;
        await db.collection('calls').doc(c.id).update({ assigned_to: userId, status:'assigned' });
        // push notification to assigned user by creating a small notification doc? For now, push UI toast and log
        showToast('Llamada asignada');
        pushLog(`Llamada ${c.id} asignada a ${userId}`);
        ov.remove();
      };
    };
    btns.appendChild(assignBtn);

    // delete
    const delBtn = document.createElement('button'); delBtn.className='btn'; delBtn.textContent='Borrar';
    delBtn.onclick = async ()=>{
      // permission: admin OR assigned officer can delete OR dispatcher
      const canDelete = STATE.currentUser && (STATE.currentUser.role === 'admin' || STATE.currentUser.role === 'dispatcher' || (c.assigned_to && c.assigned_to === STATE.currentUser.id));
      if(!canDelete){ showToast('No tienes permiso para borrar'); return; }
      if(!confirm('Borrar llamada?')) return;
      await db.collection('calls').doc(c.id).delete();
      showToast('Llamada borrada');
      pushLog(`Llamada ${c.id} borrada`);
    };
    btns.appendChild(delBtn);

    it.appendChild(btns);
    list.appendChild(it);
  });

  // show transient notifications for newly created or assigned calls
  // We'll display toasts for calls created in last 6 seconds (approx)
  const recent = snapshot.docs.filter(d=>{
    const s = d.data().createdAt;
    if(!s || !s.toDate) return false;
    return (Date.now() - s.toDate().getTime()) < 5000;
  });
  if(recent.length){
    recent.forEach(r=> showToast(`Nueva llamada: ${r.data().caller} — ${r.data().message}`,6000));
  }

  // detect recent assignments (we can watch for changes in snapshot). Simpler: skip complex diff; assignments produce logs and UI will show assigned status.
}

/* ========================= REPORTS ========================= */
function renderReports(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Informes</strong><div class="muted small">Crear y consultar informes</div></div>
    <div><button class="btn btn-small" id="closeR">Cerrar</button></div>
  </div>
  <div style="margin-top:12px">
    <div class="muted small">Plantilla (editable)</div>
    <textarea id="tplReport" style="min-height:80px"></textarea>
  </div>
  <div style="margin-top:8px" class="form-row">
    <input id="repTitle" placeholder="Título" />
    <input id="repAuthor" placeholder="Autor (auto)" />
  </div>
  <div style="margin-top:8px"><textarea id="repDesc" placeholder="Descripción..."></textarea></div>
  <div style="margin-top:8px;display:flex;gap:8px"><button id="saveRep" class="btn">Guardar informe</button><button id="clearRep" class="btn-ghost">Limpiar</button></div>
  <div style="margin-top:12px"><strong>Últimos informes</strong><div id="reportsList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeR').onclick = ()=> closeExpanded();
  // fill template from Firestore templates doc
  db.collection('templates').doc('main').get().then(s=>{
    const t = s.exists && s.data().report ? s.data().report : "Título: {{title}}\\nHechos: {{facts}}\\nAcciones: {{actions}}\\nOficial: {{author}}";
    document.getElementById('tplReport').value = t;
  });
  document.getElementById('repAuthor').value = STATE.currentUser ? STATE.currentUser.display : 'Invitado';
  document.getElementById('saveRep').onclick = saveReport;
}

async function saveReport(){
  if(!STATE.currentUser){ showToast('Inicia sesión'); return; }
  // permission check
  if(!(STATE.currentUser.role === 'admin' || STATE.currentUser.role === 'sergeant' || STATE.currentUser.role === 'officer')){ showToast('No tienes permiso para crear informes'); return; }
  const title = document.getElementById('repTitle').value.trim();
  const desc = document.getElementById('repDesc').value.trim();
  if(!title || !desc){ showToast('Título y descripción obligatorios'); return; }
  await db.collection('reports').add({ title, description: desc, author: STATE.currentUser.display, authorId: STATE.currentUser.id, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  // update template
  await db.collection('templates').doc('main').set({ report: document.getElementById('tplReport').value }, { merge:true });
  showToast('Informe creado');
  pushLog(`Informe creado: ${title}`);
}

/* Realtime */
function loadReportsRealtime(snapshot){
  let docs = [];
  snapshot.forEach(d=>docs.push({id:d.id,...d.data()}));
  const list = document.getElementById('reportsList');
  if(!list) return;
  list.innerHTML = docs.map(r=>`<div class="item"><div style="flex:1"><div style="font-weight:700">${r.title}</div><div class="muted small">${(r.description||'').slice(0,160)}</div></div>
    <div style="text-align:right"><div class="muted tiny">${r.createdAt && r.createdAt.toDate ? r.createdAt.toDate().toLocaleString() : ''}</div><div style="margin-top:6px" class="muted tiny">${r.author||''}</div>
    <div style="margin-top:6px"><button class="btn-ghost btn-small" onclick="viewReport('${r.id}')">Ver</button> ${(canDeleteReport(r) ? `<button class="btn btn-small" onclick="deleteReport('${r.id}')">Borrar</button>` : '')}</div></div></div>`).join('') || '<div class="muted small">No hay informes</div>';
}

function canDeleteReport(r){
  if(!STATE.currentUser) return false;
  return (STATE.currentUser.role === 'admin' || STATE.currentUser.role === 'sergeant' || r.authorId === STATE.currentUser.id);
}
function viewReport(id){
  db.collection('reports').doc(id).get().then(s=>{
    const d = s.data();
    if(!d) return;
    showModal(`<h3>${d.title}</h3><pre style="white-space:pre-wrap">${d.description}</pre><div class="muted small" style="margin-top:8px">Autor: ${d.author}</div>`);
  });
}
async function deleteReport(id){
  if(!confirm('Borrar informe?')) return;
  await db.collection('reports').doc(id).delete();
  showToast('Informe borrado');
  pushLog(`Informe ${id} borrado`);
}

/* ========================= WANTED ========================= */
function renderWanted(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>BOLO / Wanted</strong><div class="muted small">Crear fichas buscadas</div></div>
    <div><button class="btn btn-small" id="closeW">Cerrar</button></div>
  </div>
  <div style="margin-top:12px" class="form-row"><input id="wName" placeholder="Nombre / Alias"/><input id="wBounty" placeholder="Recompensa"/></div>
  <div style="margin-top:8px"><textarea id="wDesc" placeholder="Descripción"></textarea></div>
  <div style="margin-top:8px;display:flex;gap:8px"><button id="saveW" class="btn">Crear ficha</button></div>
  <div style="margin-top:12px"><strong>Fichas</strong><div id="wantedList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeW').onclick = ()=> closeExpanded();
  container.querySelector('#saveW').onclick = createWanted;
}

async function createWanted(){
  if(!STATE.currentUser){ showToast('Inicia sesión'); return; }
  if(!(STATE.currentUser.role === 'admin' || STATE.currentUser.role === 'sergeant' || STATE.currentUser.role === 'dispatcher')){ showToast('No tienes permiso'); return; }
  const name = document.getElementById('wName').value.trim();
  const desc = document.getElementById('wDesc').value.trim();
  const bounty = parseInt(document.getElementById('wBounty').value||'0',10);
  if(!name){ showToast('Nombre requerido'); return; }
  await db.collection('wanted').add({ name, description: desc, bounty, createdAt: firebase.firestore.FieldValue.serverTimestamp(), author: STATE.currentUser.display, authorId: STATE.currentUser.id });
  showToast('Ficha wanted creada');
  pushLog(`Wanted creado: ${name}`);
}
function loadWantedRealtime(snapshot){
  let docs=[]; snapshot.forEach(d=>docs.push({id:d.id,...d.data()}));
  const list = document.getElementById('wantedList');
  if(!list) return;
  list.innerHTML = docs.map(w=>`<div class="item"><div style="flex:1"><b>${w.name}</b><div class="muted small">${w.description}</div></div><div class="pill">${w.bounty||0}€</div>
    <div style="margin-left:12px"><button class="btn-ghost btn-small" onclick="viewWanted('${w.id}')">Ver</button> ${(canManageWanted() ? `<button class="btn btn-small" onclick="deleteWanted('${w.id}')">Borrar</button>` : '')}</div></div>`).join('') || '<div class="muted small">No hay fichas</div>';
}
function canManageWanted(){ return STATE.currentUser && (STATE.currentUser.role==='sergeant' || STATE.currentUser.role==='dispatcher' || STATE.currentUser.role==='admin'); }
function viewWanted(id){ db.collection('wanted').doc(id).get().then(s=>{ const d=s.data(); if(!d) return; showModal(`<h3>${d.name}</h3><pre style="white-space:pre-wrap">${d.description}</pre><div class="muted small">Recompensa: ${d.bounty}€</div>`); }); }
async function deleteWanted(id){ if(!confirm('Borrar wanted?')) return; await db.collection('wanted').doc(id).delete(); showToast('Wanted borrado'); pushLog(`Wanted ${id} borrado`); }

/* ========================= FINES ========================= */
function renderFines(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Multas</strong><div class="muted small">Genera sanciones</div></div>
    <div><button class="btn btn-small" id="closeF">Cerrar</button></div>
  </div>
  <div style="margin-top:12px" class="form-row"><input id="fineOff" placeholder="Infractor"/><input id="fineAmt" placeholder="Importe"/></div>
  <div style="margin-top:8px"><textarea id="fineReason" placeholder="Motivo..."></textarea></div>
  <div style="margin-top:8px;display:flex;gap:8px"><button id="saveFine" class="btn">Emitir multa</button></div>
  <div style="margin-top:12px"><strong>Multas</strong><div id="finesList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeF').onclick = ()=> closeExpanded();
  container.querySelector('#saveFine').onclick = saveFine;
}
async function saveFine(){
  if(!STATE.currentUser){ showToast('Inicia sesión'); return; }
  if(!(STATE.currentUser.role === 'admin' || STATE.currentUser.role === 'sergeant' || STATE.currentUser.role === 'officer')){ showToast('No tienes permiso'); return; }
  const off = document.getElementById('fineOff').value.trim();
  const amt = parseInt(document.getElementById('fineAmt').value||'0',10);
  const reason = document.getElementById('fineReason').value.trim();
  if(!off || !amt){ showToast('Infractor e importe requeridos'); return; }
  await db.collection('fines').add({ offender:off, amount:amt, reason, author:STATE.currentUser.display, authorId:STATE.currentUser.id, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  showToast('Multa creada');
  pushLog(`Multa creada: ${off} ${amt}€`);
}
function loadFinesRealtime(snapshot){
  let docs=[]; snapshot.forEach(d=>docs.push({id:d.id,...d.data()}));
  const list = document.getElementById('finesList'); if(!list) return;
  list.innerHTML = docs.map(f=>`<div class="item"><div style="flex:1"><b>${f.offender} • ${f.amount}€</b><div class="muted small">${f.reason}</div></div><div class="muted tiny">${f.createdAt && f.createdAt.toDate?f.createdAt.toDate().toLocaleString():''}</div>
    <div style="margin-left:12px">${(STATE.currentUser && (STATE.currentUser.role==='admin' || STATE.currentUser.display===f.author))?`<button class="btn" onclick="deleteFine('${f.id}')">Borrar</button>`:''}</div></div>`).join('') || '<div class="muted small">No hay multas</div>';
}
async function deleteFine(id){ if(!confirm('Borrar multa?')) return; await db.collection('fines').doc(id).delete(); showToast('Multa borrada'); pushLog(`Multa ${id} borrada`); }

/* ========================= SERVICE / ON DUTY ========================= */
function renderService(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Servicio</strong><div class="muted small">Ponte en servicio o sal</div></div>
    <div><button class="btn btn-small" id="closeS">Cerrar</button></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
    <div class="muted small">Tu estado:</div><div id="serviceBox" class="pill">Desconocido</div>
    <div style="margin-left:auto"><button id="toggleDuty" class="btn">Cambiar estado</button></div>
  </div>
  <div style="margin-top:12px"><strong>Policías en servicio</strong><div id="dutyList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeS').onclick = ()=> closeExpanded();
  const box = container.querySelector('#serviceBox');
  loadDutyList();
  container.querySelector('#toggleDuty').onclick = toggleDuty;
}

async function toggleDuty(){
  if(!STATE.currentUser){ showToast('Inicia sesión'); return; }
  const docRef = db.collection('onDuty').doc(STATE.currentUser.id);
  const doc = await docRef.get();
  if(!doc.exists || !doc.data().active){
    // poner en servicio
    await docRef.set({ userId: STATE.currentUser.id, display: STATE.currentUser.display, active: true, start: firebase.firestore.FieldValue.serverTimestamp() });
    showToast('En servicio');
    pushLog(`${STATE.currentUser.display} entró en servicio`);
  } else {
    // salir de servicio -> save history entry with start/end
    const d = doc.data();
    const start = d.start && d.start.toDate ? d.start.toDate().getTime() : Date.now();
    const end = Date.now();
    await db.collection('dutyHistory').add({ userId: STATE.currentUser.id, display: STATE.currentUser.display, start: d.start || firebase.firestore.FieldValue.serverTimestamp(), end: firebase.firestore.FieldValue.serverTimestamp() });
    await docRef.set({ userId: STATE.currentUser.id, display: STATE.currentUser.display, active: false, start: null, end: firebase.firestore.FieldValue.serverTimestamp() });
    showToast('Fuera de servicio');
    pushLog(`${STATE.currentUser.display} salió de servicio`);
  }
}

function loadDutyRealtime(snapshot){
  // update header counts and duty list
  const users = window.latestUsers || [];
  const active = [];
  snapshot.forEach(d=>{
    const data = d.data();
    if(data.active) active.push(data);
  });
  // update UI count
  dutyStatus.textContent = `En servicio: ${active.length}`;
  // update expanded duty list if present
  const list = document.getElementById('dutyList');
  if(list){
    list.innerHTML = active.map(a=>`<div class="item"><div><b>${a.display}</b><div class="muted small">Desde: ${a.start && a.start.toDate ? a.start.toDate().toLocaleString() : ''}</div></div></div>`).join('') || '<div class="muted small">Nadie en servicio</div>';
  }
}

/* initial load of duty list */
async function loadDutyList(){
  const snap = await db.collection('onDuty').get();
  const active = [];
  snap.forEach(d=>{ const data=d.data(); if(data.active) active.push(data); });
  const list = document.getElementById('dutyList');
  if(list) list.innerHTML = active.map(a=>`<div class="item"><div><b>${a.display}</b><div class="muted small">Desde: ${a.start && a.start.toDate ? a.start.toDate().toLocaleString() : ''}</div></div></div>`).join('') || '<div class="muted small">Nadie en servicio</div>';
  dutyStatus.textContent = `En servicio: ${active.length}`;
}

/* ========================= ADMIN ========================= */
function renderAdmin(container){
  // only visible to admin (or impersonator admin)
  if(!isAdminEffective()){
    container.innerHTML = `<div><strong>Administración</strong><div class="muted small">Acceso restringido. Solo administradores.</div></div>`;
    return;
  }
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Administración</strong><div class="muted small">Gestiona roles, permisos y usuarios</div></div>
    <div><button class="btn btn-small" id="closeA">Cerrar</button></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:12px">
    <div style="flex:1">
      <h4>Usuarios</h4>
      <div id="usersAdminList" class="list"></div>
    </div>
    <div style="width:360px">
      <h4>Crear usuario (solo admin)</h4>
      <input id="adm_newUser" placeholder="username"><input id="adm_newDisplay" placeholder="display"><input id="adm_newPass" placeholder="password">
      <select id="adm_newRole"><option value="officer">officer</option><option value="sergeant">sergeant</option><option value="dispatcher">dispatcher</option><option value="admin">admin</option></select>
      <div style="display:flex;gap:8px;margin-top:8px"><button id="adm_createUser" class="btn">Crear</button><button id="adm_refresh" class="btn-ghost">Refrescar</button></div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">
      <h4>Roles</h4>
      <div style="display:flex;gap:8px"><input id="adm_newRoleName" placeholder="nuevo rol"><button id="adm_createRole" class="btn">Crear rol</button></div>
      <div id="rolesAdminList" style="margin-top:12px"></div>
    </div>
  </div>`;
  container.querySelector('#closeA').onclick = ()=> closeExpanded();
  container.querySelector('#adm_createUser').onclick = adminCreateUser;
  container.querySelector('#adm_refresh').onclick = ()=> renderAdmin(container);
  container.querySelector('#adm_createRole').onclick = adminCreateRole;
  loadUsersAdmin();
  loadRolesAdmin();
}

function isAdminEffective(){
  // Returns true if current session is admin OR impersonator is admin
  if(!STATE.currentUser) return false;
  // If we are impersonating but impersonatorId exists and that impersonator is admin
  if(STATE.impersonatorId){
    // check impersonator record in latestUsers
    const imp = (window.latestUsers || []).find(u=>u.id === STATE.impersonatorId);
    if(imp && imp.role === 'admin') return true;
  }
  return STATE.currentUser.role === 'admin';
}

async function loadUsersAdmin(){
  const usersSnap = await db.collection('users').orderBy('display').get();
  const users = usersSnap.docs.map(d=>d.data());
  window.latestUsers = users;
  const ul = document.getElementById('usersAdminList');
  if(!ul) return;
  ul.innerHTML = '';
  users.forEach(u=>{
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `<div><b>${u.display} (${u.username})</b><div class="muted small">Rol: <span class="role-chip">${u.role}</span> • Badge: ${u.badge||'—'}</div></div>
      <div style="text-align:right">
        <select data-uid="${u.id}" class="adm_role_sel">${Object.keys(getRolesObj()).map(r=>`<option value="${r}" ${u.role===r?'selected':''}>${r}</option>`).join('')}</select>
        <div style="margin-top:6px"><button class="btn-ghost btn-small" data-uid="${u.id}" data-act="del">Borrar</button> <button class="btn btn-small" data-uid="${u.id}" data-act="imp">Impersonar</button></div>
      </div>`;
    ul.appendChild(div);
  });
  // attach events
  ul.querySelectorAll('.adm_role_sel').forEach(sel=>{
    sel.onchange = (e)=> changeUserRole(e.target.dataset.uid, e.target.value);
  });
  ul.querySelectorAll('button[data-act="del"]').forEach(b=>{
    b.onclick = async ()=>{
      const uid = b.dataset.uid;
      if(!confirm('Borrar usuario?')) return;
      const uDoc = await db.collection('users').doc(uid).get();
      const udata = uDoc.exists ? uDoc.data() : null;
      if(udata && udata.username === 'admin'){ alert('No puedes borrar el admin seed'); return; }
      // if user is in service, remove them from onDuty
      await db.collection('onDuty').doc(uid).delete().catch(()=>{});
      await db.collection('users').doc(uid).delete();
      showToast('Usuario borrado');
      pushLog(`Usuario borrado: ${uid}`);
      loadUsersAdmin();
    };
  });
  ul.querySelectorAll('button[data-act="imp"]').forEach(b=>{
    b.onclick = async ()=>{
      const uid = b.dataset.uid;
      const uDoc = await db.collection('users').doc(uid).get();
      if(!uDoc.exists) return;
      const u = uDoc.data();
      // impersonation: keep impersonator id so admin privileges are preserved
      const adminId = STATE.currentUser.id;
      STATE.impersonatorId = adminId; // record impersonator
      // set current user to the impersonated user locally
      STATE.currentUser = u;
      localStorage.setItem('currentUser', JSON.stringify(u));
      updateHeader();
      showToast('Impersonando: ' + u.display);
      pushLog(`Impersonación: ${u.username} por ${adminId}`);
      // re-render admin panel to reflect impersonation still allowed
      renderAdmin(document.querySelector('.expanded'));
    };
  });
}

/* change user role */
async function changeUserRole(uid, newRole){
  if(!isAdminEffective()){ showToast('No autorizado'); return; }
  const uRef = db.collection('users').doc(uid);
  const uDoc = await uRef.get();
  if(!uDoc.exists) return;
  await uRef.update({ role: newRole });
  showToast('Rol actualizado');
  pushLog(`Rol cambiado: ${uid} -> ${newRole}`);
  loadUsersAdmin();
}

/* admin create user (only admin effective) */
async function adminCreateUser(){
  if(!isAdminEffective()){ modalAlert('Error','Solo admin puede crear usuarios'); return; }
  const username = document.getElementById('adm_newUser').value.trim();
  const display = document.getElementById('adm_newDisplay').value.trim() || username;
  const pass = document.getElementById('adm_newPass').value.trim() || '1234';
  const role = document.getElementById('adm_newRole').value;
  if(!username){ modalAlert('Error','Username requerido'); return; }
  // create with doc id unique
  const id = 'u_' + Date.now().toString(36);
  await db.collection('users').doc(id).set({
    id,
    username,
    display,
    badge: '',
    password: pass,
    role,
    createdBy: STATE.impersonatorId ? STATE.impersonatorId : (STATE.currentUser ? STATE.currentUser.id : 'system'),
    createdByRole: (STATE.currentUser ? STATE.currentUser.role : 'admin'),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  showToast('Usuario creado');
  pushLog(`Usuario admin creado: ${username}`);
  // clear fields
  document.getElementById('adm_newUser').value=''; document.getElementById('adm_newDisplay').value=''; document.getElementById('adm_newPass').value='';
  loadUsersAdmin();
}

/* Roles management */
function getRolesObj(){
  // roles stored under roles/doc 'roles' or 'defaultRoles' earlier
  return window.latestRoles || { officer:{name:'Officer', color:'#7c3aed', permissions:['create_reports','create_pda','create_call']}, sergeant:{name:'Sergeant', color:'#3b82f6', permissions:['create_reports','delete_reports','create_pda','create_call']}, dispatcher:{name:'Dispatcher', color:'#f97316', permissions:['create_call','assign_call']}, admin:{name:'Admin', color:'#10b981', permissions:['all']} };
}
async function loadRolesAdmin(){
  // read roles doc
  const rolesSnap = await db.collection('roles').doc('defaultRoles').get();
  const roles = rolesSnap.exists ? rolesSnap.data() : getRolesObj();
  window.latestRoles = roles;
  const out = document.getElementById('rolesAdminList');
  if(!out) return;
  out.innerHTML = '';
  for(const key in roles){
    const r = roles[key];
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `<div style="flex:1"><b>${key}</b><div class="muted small">Permisos:</div><div id="permBox_${key}" style="margin-top:6px"></div></div>
      <div style="text-align:right"><button class="btn-ghost" data-role="${key}" data-act="edit">Editar</button> <button class="btn" data-role="${key}" data-act="del">Borrar</button></div>`;
    out.appendChild(div);
    const box = div.querySelector(`#permBox_${key}`);
    box.innerHTML = (r.permissions && r.permissions.length) ? r.permissions.map(p=>`<span class="role-chip">${p}</span>`).join('') : '<span class="muted tiny">Sin permisos</span>';
  }
  // attach events
  out.querySelectorAll('button[data-act="edit"]').forEach(b=> b.onclick = ()=>{
    const roleKey = b.dataset.role; openRoleEditor(roleKey);
  });
  out.querySelectorAll('button[data-act="del"]').forEach(b=> b.onclick = async ()=>{
    const roleKey = b.dataset.role; if(!confirm('Borrar rol? (Los usuarios con este rol quedarán con rol vacío)')) return;
    const rolesObj = window.latestRoles || {};
    delete rolesObj[roleKey];
    await db.collection('roles').doc('defaultRoles').set(rolesObj);
    // remove role from users
    const usersSnap = await db.collection('users').where('role','==',roleKey).get();
    const batch = db.batch();
    usersSnap.forEach(us=> batch.update(us.ref, { role: '' }));
    await batch.commit();
    pushLog(`Rol borrado: ${roleKey}`);
    loadRolesAdmin();
    loadUsersAdmin();
  });
}

function openRoleEditor(roleKey){
  const roles = window.latestRoles || {};
  const role = roles[roleKey];
  if(!role){ modalAlert('Error','Rol no existe'); return; }
  const modal = document.createElement('div'); modal.className='overlay';
  modal.innerHTML = `<div class="modal">
    <h3>Editar rol: ${roleKey}</h3>
    <div class="muted small">Marca los permisos que tendrá este rol</div>
    <div style="margin-top:12px" id="permChecks"></div>
    <div style="display:flex;gap:8px;margin-top:12px"><button id="saveRole" class="btn">Guardar</button><button id="cancelRole" class="btn-ghost">Cancelar</button></div>
  </div>`;
  document.body.appendChild(modal);
  const permsList = ['create_reports','delete_reports','create_pda','create_call','assign_call','create_bolo','manage_wanted','create_fine','export','all'];
  const box = modal.querySelector('#permChecks');
  box.innerHTML = permsList.map(p=>`<div style="margin-bottom:6px"><label><input type="checkbox" data-perm="${p}" ${role.permissions.includes(p)?'checked':''}/> ${p}</label></div>`).join('');
  modal.querySelector('#cancelRole').onclick = ()=> modal.remove();
  modal.querySelector('#saveRole').onclick = async ()=>{
    const checked = Array.from(box.querySelectorAll('input[type=checkbox]:checked')).map(c=>c.dataset.perm);
    role.permissions = checked;
    roles[roleKey] = role;
    await db.collection('roles').doc('defaultRoles').set(roles);
    pushLog(`Rol editado: ${roleKey}`);
    modal.remove();
    loadRolesAdmin();
    loadUsersAdmin();
  };
}

/* create new role */
async function adminCreateRole(){
  if(!isAdminEffective()){ modalAlert('Error','Solo admin puede crear roles'); return; }
  const name = document.getElementById('adm_newRoleName').value.trim();
  if(!name){ modalAlert('Error','Nombre rol requerido'); return; }
  const roles = window.latestRoles || {};
  if(roles[name]){ modalAlert('Error','Rol ya existe'); return; }
  roles[name] = { name, color:'#999999', permissions:[] };
  await db.collection('roles').doc('defaultRoles').set(roles);
  pushLog(`Rol creado: ${name}`);
  document.getElementById('adm_newRoleName').value='';
  loadRolesAdmin();
  loadUsersAdmin();
}

/* ========================= LOGS (auditoría) ========================= */
function renderLogs(container){
  if(!isAdminEffective()){
    container.innerHTML = `<div><strong>Auditoría</strong><div class="muted small">Acceso restringido a administradores.</div></div>`;
    return;
  }
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Auditoría</strong><div class="muted small">Últimas acciones</div></div>
    <div><button class="btn btn-small" id="closeL">Cerrar</button></div>
  </div>
  <div style="margin-top:12px" id="logsList" class="list"></div>`;
  container.querySelector('#closeL').onclick = ()=> closeExpanded();
  // load from window.latestLogs
  const list = document.getElementById('logsList');
  const logs = window.latestLogs || [];
  list.innerHTML = logs.map(l=>`<div class="item"><div><div style="font-weight:700">${l.msg}</div><div class="muted small">${l.actor||''} • ${l.t && l.t.toDate?l.t.toDate().toLocaleString():''}</div></div></div>`).join('') || '<div class="muted small">Sin logs</div>';
}

/* ========================= TOOLS / ALERTAS / INCAUTACIONES ========================= */
function renderTools(container){
  // Here we repurposed tools to be 'Alertas / Incautaciones'
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Alertas / Incautaciones</strong><div class="muted small">Gestiona alertas de ciudad, incautaciones y niveles de alerta</div></div>
    <div><button class="btn btn-small" id="closeT">Cerrar</button></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:8px">
    <select id="alertLevel"><option value="green">Verde</option><option value="yellow">Amarilla</option><option value="red">Roja</option></select>
    <input id="alertMsg" placeholder="Mensaje de alerta (opcional)"/>
    <button id="createAlertBtn" class="btn">Crear alerta</button>
  </div>
  <div style="margin-top:12px"><strong>Alertas activas</strong><div id="alertsList" class="list" style="margin-top:8px"></div></div>
  <div style="margin-top:12px"><strong>Incautaciones</strong><div id="seizuresList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeT').onclick = ()=> closeExpanded();
  container.querySelector('#createAlertBtn').onclick = createAlert;
  // realtime listeners for alerts and seizures are in main realtime setup
}

/* create alert - visible to all */
async function createAlert(){
  if(!STATE.currentUser){ showToast('Inicia sesión'); return; }
  // any logged user can create alerts, but only admin can delete them
  const level = document.getElementById('alertLevel').value;
  const msg = document.getElementById('alertMsg').value.trim();
  await db.collection('alerts').add({ level, message: msg, createdBy: STATE.currentUser.display, createdById: STATE.currentUser.id, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  showToast('Alerta creada');
  pushLog(`Alerta creada: ${level} ${msg}`);
}

/* delete alert function (admin only) */
async function deleteAlert(id){
  if(!isAdminEffective()){ showToast('Solo admin puede borrar alertas'); return; }
  if(!confirm('Borrar alerta?')) return;
  await db.collection('alerts').doc(id).delete();
  showToast('Alerta borrada');
  pushLog(`Alerta ${id} borrada`);
}

/* load alerts realtime */
function loadAlertsRealtime(snapshot){
  const docs = []; snapshot.forEach(d=>docs.push({id:d.id,...d.data()}));
  const list = document.getElementById('alertsList');
  if(!list) return;
  list.innerHTML = docs.map(a=>`<div class="item"><div style="flex:1"><b>${a.level.toUpperCase()}</b><div class="muted small">${a.message||''}</div></div>
    <div style="text-align:right"><div class="muted tiny">${a.createdAt && a.createdAt.toDate? a.createdAt.toDate().toLocaleString() : ''}</div>
    <div style="margin-top:6px">${isAdminEffective() ? `<button class="btn" onclick="deleteAlert('${a.id}')">Borrar</button>` : ''}</div></div></div>`).join('') || '<div class="muted small">Sin alertas</div>';
}

/* load seizures realtime (incautaciones) */
function loadSeizuresRealtime(snapshot){
  const docs = []; snapshot.forEach(d=>docs.push({id:d.id,...d.data()}));
  const list = document.getElementById('seizuresList');
  if(!list) return;
  list.innerHTML = docs.map(s=>`<div class="item"><div style="flex:1"><b>${s.vehicle||'Vehículo'}</b><div class="muted small">${s.reason||''}</div></div><div class="muted tiny">${s.date && s.date.toDate? s.date.toDate().toLocaleString():''}</div></div>`).join('') || '<div class="muted small">Sin incautaciones</div>';
}

/* ========================= USERS + LOGIN (propio) ========================= */
document.getElementById('btnLogin').onclick = ()=> {
  if(STATE.currentUser){ if(confirm('Cerrar sesión?')){ localStorage.removeItem('currentUser'); STATE.currentUser=null; STATE.impersonatorId=null; updateHeader(); showToast('Sesión cerrada'); } } else openLoginModal();
};
document.getElementById('btnExport').onclick = ()=> exportAll;

/* login modal controls */
function openLoginModal(){ loginModal.classList.remove('hidden'); document.getElementById('loginUser').focus(); }
function closeLoginModal(){ loginModal.classList.add('hidden'); document.getElementById('loginPass').value=''; document.getElementById('loginUser').value=''; document.getElementById('loginError').style.display='none'; }
document.getElementById('guestBtn').onclick = ()=> { STATE.currentUser = null; localStorage.removeItem('currentUser'); updateHeader(); closeLoginModal(); showToast('Entró como invitado'); };

document.getElementById('loginBtn').onclick = async ()=>{
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  if(!u || !p){ document.getElementById('loginError').style.display='block'; document.getElementById('loginError').textContent='Usuario y contraseña requeridos'; return; }
  const snap = await db.collection('users').where('username','==',u).where('password','==',p).limit(1).get();
  if(snap.empty){ document.getElementById('loginError').style.display='block'; document.getElementById('loginError').textContent='Usuario o contraseña incorrectos'; return; }
  const user = snap.docs[0].data();
  STATE.currentUser = user;
  localStorage.setItem('currentUser', JSON.stringify(user));
  updateHeader();
  closeLoginModal();
  showToast('Sesión iniciada: ' + user.display);
  pushLog(`Sesión iniciada: ${user.username}`);
};

/* Only admin can create accounts through adminCreateUser (UI implemented there).
   Public registration is disabled to avoid free creation as requested. */

/* ------------------- EXPORT / IMPORT / CLEAR ------------------- */
async function exportAll(){
  if(!isAdminEffective()){ showToast('Solo admin puede exportar'); return; }
  // fetch collections
  const collections = ['users','reports','wanted','calls','pda','fines','templates','alerts','seizures','logs'];
  const data = {};
  for(const c of collections){
    const snap = await db.collection(c).get();
    data[c] = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  }
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = 'daynightrp_export_'+Date.now()+'.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  showToast('Exportado JSON');
}

/* ------------------- REaltime loader wrappers ------------------- */
function loadPDARealtimeWrapper(){ db.collection('pda').orderBy('createdAt','desc').onSnapshot(loadPDARealtime); }
function loadReportsRealtimeWrapper(){ db.collection('reports').orderBy('createdAt','desc').onSnapshot(loadReportsRealtime); }
function loadWantedRealtimeWrapper(){ db.collection('wanted').orderBy('createdAt','desc').onSnapshot(loadWantedRealtime); }
function loadCallsRealtimeWrapper(){ db.collection('calls').orderBy('createdAt','desc').onSnapshot(loadCallsRealtime); }
function loadFinesRealtimeWrapper(){ db.collection('fines').orderBy('createdAt','desc').onSnapshot(loadFinesRealtime); }
function loadUsersRealtimeWrapper(){ db.collection('users').orderBy('display').onSnapshot(snap=>{ window.latestUsers = snap.docs.map(d=>d.data()); /* re-render admin list if open */ if(STATE.expanded==='admin') loadUsersAdmin(); }); }
function loadAlertsRealtimeWrapper(){ db.collection('alerts').orderBy('createdAt','desc').onSnapshot(loadAlertsRealtime); }
function loadSeizuresRealtimeWrapper(){ db.collection('seizures').orderBy('date','desc').onSnapshot(loadSeizuresRealtime); }

/* attach many realtime listeners in startRealtime() */
function loadUsersRealtime(snapshot){ window.latestUsers = snapshot.docs.map(d=>d.data()); }
function loadWantedRealtime(snapshot){ loadWantedRealtime(snapshot); }
function loadFinesRealtime(snapshot){ loadFinesRealtime(snapshot); }

/* ------------------- Inicialización UI y realtime ------------------- */
async function initUI(){
  // seed default data if empty
  await seedIfNeeded();
  renderCards();
  // restore session from localStorage
  const stored = localStorage.getItem('currentUser');
  if(stored){ try{ STATE.currentUser = JSON.parse(stored); }catch(e){ STATE.currentUser = null; } }
  updateHeader();
  // start realtime subscriptions
  startRealtime();
  // additional separate listeners
  loadPDARealtimeWrapper();
  loadReportsRealtimeWrapper();
  loadWantedRealtimeWrapper();
  loadCallsRealtimeWrapper();
  loadFinesRealtimeWrapper();
  loadUsersRealtimeWrapper();
  loadAlertsRealtimeWrapper();
  loadSeizuresRealtimeWrapper();
  // roles
  db.collection('roles').doc('defaultRoles').get().then(s=>{ if(s.exists) window.latestRoles = s.data(); else db.collection('roles').doc('defaultRoles').set(getRolesObj()); loadRolesAdmin(); });
  // logs
  db.collection('logs').orderBy('t','desc').limit(200).onSnapshot(s=>{ window.latestLogs = s.docs.map(d=>({id:d.id,...d.data()})); });
  // onDuty
  db.collection('onDuty').onSnapshot(loadDutyRealtime);
}

/* update header UI */
function updateHeader(){
  // ensure currentUser object is fresh from Firestore if possible
  if(STATE.currentUser && STATE.currentUser.id){
    // fetch latest user doc
    db.collection('users').doc(STATE.currentUser.id).get().then(s=>{
      if(s.exists){
        STATE.currentUser = s.data();
        localStorage.setItem('currentUser', JSON.stringify(STATE.currentUser));
        userDisplay.textContent = `${STATE.currentUser.display} (${STATE.currentUser.role})`;
      } else {
        // removed user
        STATE.currentUser = null;
        localStorage.removeItem('currentUser');
        userDisplay.textContent = 'No conectado';
      }
    }).catch(()=>{ userDisplay.textContent = STATE.currentUser ? `${STATE.currentUser.display} (${STATE.currentUser.role})` : 'No conectado'; });
  } else {
    userDisplay.textContent = 'No conectado';
  }
  // duty count updated by loadDutyRealtime
}

/* ------------------- Utility small helpers ------------------- */
function modalAlert(title,msg){ showModal(`<h3>${title}</h3><div style="white-space:pre-wrap">${msg}</div>`); }

/* ------------------- Start app ------------------- */
initUI();

/* Expose some functions to window for onclick from generated HTML */
window.viewPDA = viewPDA;
window.delPDA = tryDeletePDA;
window.viewReport = viewReport;
window.deleteReport = deleteReport;
window.deleteWanted = deleteWanted;
window.deleteFine = deleteFine;
window.deleteCall = async function(id){ await db.collection('calls').doc(id).delete(); };
window.deleteAlert = deleteAlert;

</script>
</body>
</html>
